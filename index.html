<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Chat Node</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/your-font-awesome-key.js" crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* --- Base & Typography --- */
        :root {
            --bg-dark: #0a0a1a;
            --neon-blue: #00ffff;
            --neon-purple: #d600ff;
            --text-light: #e0e0e0;
            --glow-filter: drop-shadow(0 0 5px var(--neon-blue)) drop-shadow(0 0 2px rgba(0, 255, 255, 0.5));
        }
        body, html {
            height: 100%;
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Roboto Mono', monospace;
            overflow: hidden; /* Hide scrollbars for the space background effect */
        }

        /* --- Global Layout --- */
        #container {
            display: flex;
            height: 100vh;
            width: 100vw;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10;
            position: relative;
        }
        #sidebar {
            width: 280px;
            background-color: rgba(10, 10, 26, 0.95);
            border-right: 1px solid rgba(0, 255, 255, 0.2);
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 20px;
        }

        /* --- Header & Navigation --- */
        #header {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8em;
            color: var(--neon-blue);
            filter: var(--glow-filter);
            margin-bottom: 20px;
            text-align: center;
        }
        #nav-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .nav-tab {
            padding: 10px 15px;
            background-color: rgba(0, 255, 255, 0.1);
            color: var(--text-light);
            border: 1px solid rgba(0, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }
        .nav-tab:hover {
            background-color: rgba(0, 255, 255, 0.2);
        }
        .nav-tab.active {
            background-color: var(--neon-blue);
            color: var(--bg-dark);
            font-weight: bold;
            box-shadow: 0 0 10px var(--neon-blue);
        }

        /* --- View Sections --- */
        .view-section {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            height: 100%;
            overflow: hidden;
            border: 1px solid rgba(0, 255, 255, 0.2);
            padding: 15px;
            box-sizing: border-box;
        }
        .view-section.active {
            display: flex;
        }

        /* --- Chat View --- */
        #messages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding-right: 10px;
            scrollbar-width: thin;
            scrollbar-color: var(--neon-blue) transparent;
        }
        .message-row {
            display: flex;
            margin-bottom: 8px;
            max-width: 80%;
        }
        .message-row.mine {
            justify-content: flex-end;
            margin-left: auto;
        }
        .message-row.theirs {
            justify-content: flex-start;
        }
        .msg-bubble {
            padding: 8px 12px;
            border-radius: 15px;
            word-wrap: break-word;
            max-width: 100%;
        }
        .msg-bubble.public {
            background-color: rgba(0, 255, 255, 0.15);
            border-left: 3px solid var(--neon-blue);
        }
        .msg-bubble.system {
            background-color: rgba(255, 0, 0, 0.1);
            border-left: 3px solid red;
            font-style: italic;
            color: #ffaaaa;
        }
        .msg-bubble.admin {
            background-color: rgba(214, 0, 255, 0.15);
            border-left: 3px solid var(--neon-purple);
        }
        .msg-bubble.dm-private {
            background-color: rgba(214, 0, 255, 0.15);
            border: 1px solid var(--neon-purple);
        }
        .msg-meta {
            font-size: 0.75em;
            margin-bottom: 3px;
        }

        #chat-input-container {
            display: flex;
            align-items: center;
        }
        #message-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--neon-blue);
            background-color: rgba(0, 0, 0, 0.5);
            color: var(--text-light);
            font-family: inherit;
            margin-right: 10px;
        }
        .send-btn {
            padding: 10px 15px;
            background-color: var(--neon-blue);
            color: var(--bg-dark);
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        /* --- User List --- */
        #user-list-header {
            font-family: 'Orbitron', sans-serif;
            color: var(--neon-purple);
            font-size: 1.1em;
            border-bottom: 1px solid rgba(214, 0, 255, 0.3);
            padding-bottom: 5px;
        }
        #user-list {
            flex-grow: 1;
            overflow-y: auto;
            padding-top: 10px;
        }
        .user-item {
            display: flex;
            align-items: center;
            padding: 5px 0;
            gap: 10px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            box-shadow: 0 0 5px;
        }
        .status-chat { background-color: var(--neon-blue); box-shadow: 0 0 5px var(--neon-blue); }
        .status-hub { background-color: #00ff00; box-shadow: 0 0 5px #00ff00; }
        .status-admin { background-color: #ff6600; box-shadow: 0 0 5px #ff6600; }
        .status-dm { background-color: var(--neon-purple); box-shadow: 0 0 5px var(--neon-purple); }

        /* --- Hub View --- */
        #hub-view iframe {
            width: 100%;
            height: 100%;
            border: none;
            background-color: #000;
        }
        #hub-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        #hub-url-input {
            flex-grow: 1;
            padding: 8px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #999;
            color: var(--text-light);
            font-family: inherit;
        }

        /* --- DM View --- */
        #dm-view {
            display: grid;
            grid-template-rows: 1fr;
            height: 100%;
        }
        #dm-lobby {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            overflow-y: auto;
        }
        .dm-user-card {
            background-color: rgba(214, 0, 255, 0.1);
            border: 1px solid var(--neon-purple);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dm-user-card:hover {
            background-color: rgba(214, 0, 255, 0.3);
            box-shadow: 0 0 10px var(--neon-purple);
        }
        #dm-active-chat {
            display: none; /* Controlled by JS */
            flex-direction: column;
            height: 100%;
        }
        #dm-partner-name {
            font-family: 'Orbitron', sans-serif;
            color: var(--neon-purple);
            font-size: 1.2em;
            margin-bottom: 10px;
            text-align: center;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(214, 0, 255, 0.5);
        }
        #dm-messages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding-right: 10px;
        }
        #dm-input-container {
            display: flex;
            align-items: center;
        }
        #dm-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--neon-purple);
            background-color: rgba(0, 0, 0, 0.5);
            color: var(--text-light);
            font-family: inherit;
            margin-right: 10px;
        }
        .dm-exit-btn {
            background-color: #ff3333;
            color: var(--bg-dark);
        }

        /* --- Admin View --- */
        #admin-view {
            display: none;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
        }
        .admin-section {
            border: 1px solid rgba(255, 102, 0, 0.3);
            padding: 15px;
            background-color: rgba(255, 102, 0, 0.1);
        }
        .admin-section h3 {
            color: #ff6600;
            font-family: 'Orbitron', sans-serif;
            margin-top: 0;
            border-bottom: 1px solid rgba(255, 102, 0, 0.5);
            padding-bottom: 5px;
        }
        .admin-section input, .admin-section select {
            padding: 8px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #ff6600;
            color: var(--text-light);
            font-family: inherit;
            margin-right: 10px;
        }
        .admin-btn {
            padding: 8px 15px;
            background-color: #ff6600;
            color: var(--bg-dark);
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        /* --- Modals & Overlays --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--bg-dark);
            border: 2px solid var(--neon-blue);
            box-shadow: 0 0 20px var(--neon-blue);
            padding: 30px;
            text-align: center;
            font-family: 'Orbitron', sans-serif;
            width: 300px;
        }
        .modal-content input {
            padding: 10px;
            margin: 10px 0;
            width: 100%;
            box-sizing: border-box;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--neon-blue);
            color: var(--text-light);
            font-family: inherit;
        }
        .modal-content button {
            margin-top: 15px;
            padding: 10px 20px;
            background-color: var(--neon-blue);
            color: var(--bg-dark);
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        /* DM Request Modal */
        #dm-request-modal .modal-content {
            border-color: var(--neon-purple);
            box-shadow: 0 0 20px var(--neon-purple);
        }
        #dm-request-modal button {
            background-color: var(--neon-purple);
            margin: 0 10px;
        }

        /* Announcement Overlay */
        #announcement-overlay .modal-content {
            border-color: #ff6600;
            box-shadow: 0 0 20px #ff6600;
        }
        #announcement-overlay .modal-content button {
            background-color: #ff6600;
        }

        /* Notification Toast */
        #notification-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column-reverse; /* Newest on bottom */
            gap: 10px;
        }
        .toast {
            padding: 15px 20px;
            min-width: 250px;
            border-left: 5px solid;
            background-color: rgba(0, 0, 0, 0.8);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.5s, fadeOut 0.5s 4.5s;
        }
        .toast.success { border-color: #00ff00; color: #00ff00; }
        .toast.warning { border-color: var(--neon-blue); color: var(--neon-blue); }
        .toast.error { border-color: #ff0000; color: #ff0000; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(20px); } }
    </style>
</head>
<body>

    <div id="login-modal" class="modal-overlay" style="display: flex;">
        <div class="modal-content">
            <h2>GALACTIC NODE UPLINK</h2>
            <input type="text" id="username-input" placeholder="Enter Codename">
            <input type="password" id="password-input" placeholder="Enter Clearance Key (Optional)">
            <button onclick="attemptLogin()">CONNECT</button>
            <p id="login-error" style="color: red; margin-top: 10px; font-size: 0.9em;"></p>
        </div>
    </div>

    <div id="dm-request-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color: var(--neon-purple);">INCOMING SECURE LINK</h3>
            <p id="dm-req-text"></p>
            <button onclick="acceptDM()">ACCEPT</button>
            <button onclick="rejectDM()" style="background-color: gray;">DENY</button>
        </div>
    </div>

    <div id="announcement-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color: #ff6600;">COMMUNICATION BROADCAST</h3>
            <p id="announce-text"></p>
            <p id="announce-sender" style="font-style: italic; font-size: 0.8em;"></p>
            <button onclick="document.getElementById('announcement-overlay').style.display = 'none';">DISMISS</button>
        </div>
    </div>

    <div id="container">
        <div id="sidebar">
            <div id="header">NODE STATUS</div>
            <div id="user-list-header">ACTIVE CADETS</div>
            <div id="user-list">
                </div>
        </div>

        <div id="main-content">
            <div id="nav-bar">
                <div id="chat-tab" class="nav-tab active" onclick="switchTab('chat')">Comms</div>
                <div id="hub-tab" class="nav-tab" onclick="switchTab('hub')">Hub</div>
                <div id="dm-tab" class="nav-tab" onclick="switchTab('dm')">Secure Link</div>
                <div id="admin-tab" class="nav-tab" style="display: none;" onclick="switchTab('admin')">Command Deck</div>
            </div>

            <div id="chat-view" class="view-section active">
                <div id="messages">
                    </div>
                <div id="chat-input-container">
                    <input type="text" id="message-input" placeholder="Transmit message..." maxlength="255">
                    <button class="send-btn" onclick="sendMessage()">SEND</button>
                </div>
            </div>

            <div id="hub-view" class="view-section">
                <div id="hub-controls">
                    <input type="url" id="hub-url-input" placeholder="Enter target URL (e.g., https://example.com)">
                    <button class="send-btn" onclick="loadHub()">LOAD</button>
                </div>
                <iframe id="hub-iframe" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
            </div>

            <div id="dm-view" class="view-section">
                <div id="dm-lobby">
                    </div>
                <div id="dm-active-chat">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 id="dm-partner-name">LINKED: UNKNOWN</h4>
                        <button class="send-btn dm-exit-btn" onclick="exitDM()">EXIT LINK</button>
                    </div>
                    
                    <div id="dm-messages" style="flex-grow: 1; overflow-y: auto;">
                        </div>
                    <div id="dm-input-container">
                        <input type="text" id="dm-input" placeholder="Transmit encrypted message..." maxlength="255">
                        <button class="send-btn" onclick="sendDM()">SEND</button>
                    </div>
                </div>
            </div>

            <div id="admin-view" class="view-section">
                <div class="admin-section">
                    <h3>SYSTEM BROADCAST</h3>
                    <input type="text" id="announce-input" placeholder="Enter announcement text..." style="width: 70%;">
                    <button class="admin-btn" onclick="sendAnnouncement()">SEND ANNOUNCE</button>
                </div>

                <div class="admin-section">
                    <h3>IDENTITY MANAGEMENT (Ban/Exile)</h3>
                    <select id="user-select" style="width: 30%;">
                        <option value="">Select Target...</option>
                    </select>
                    <button class="admin-btn" style="background-color: #cc0000;" onclick="banUser()">PERMANENT EXILE (BAN)</button>
                </div>

                <div class="admin-section">
                    <h3>LANGUAGE CENSORSHIP (Word Filter)</h3>
                    <input type="text" id="ban-word-input" placeholder="Enter word to prohibit" style="width: 30%;">
                    <button class="admin-btn" onclick="banWord()">PROHIBIT WORD</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notification-container"></div>

    <script>
        let socket;
        let myData = null;
        let currentDMPartnerId = null;
        let incomingRequestFrom = null;

        // --- Notification System ---
        function showNotification(message, type) {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 5000);
        }

        // --- Login & Initialization ---
        function attemptLogin() {
            const name = document.getElementById('username-input').value.trim();
            const password = document.getElementById('password-input').value.trim();

            if (!name) {
                document.getElementById('login-error').innerText = "Codename is required.";
                return;
            }

            // --- SOCKET INITIALIZATION (FIXED) ---
            if (!socket) {
                // Robust connection settings to prevent random disconnects
                socket = io({
                    reconnection: true,
                    reconnectionDelayMax: 10000,
                    reconnectionAttempts: Infinity, 
                    timeout: 60000
                });

                socket.on('connect', () => {
                    document.getElementById('login-error').innerText = '';
                    // Re-emit join event on reconnect if myData exists
                    if (myData) {
                        socket.emit('join', { name: myData.name, password: password });
                    }
                });

                socket.on('disconnect', (reason) => {
                    showNotification(`CONNECTION LOST: ${reason.toUpperCase()}`, "error");
                    // The robust settings above handle reconnection automatically
                });
                
                socket.on('banAlert', (msg) => {
                    showNotification(msg, "error");
                    setTimeout(() => { window.location.reload(); }, 3000);
                });

                socket.on('loginError', (msg) => {
                    document.getElementById('login-error').innerText = msg;
                });

                socket.on('loginSuccess', (data) => {
                    myData = data.user;
                    document.getElementById('login-modal').style.display = 'none';
                    if (myData.role === 'Admin' || myData.role === 'Owner') {
                        document.getElementById('admin-tab').style.display = 'flex';
                    }
                    showNotification(`UPLINK ESTABLISHED: Welcome, ${myData.name}`, "success");
                    // Ensure initial status is set
                    switchTab('chat');
                });

                socket.on('message', (msg) => {
                    const container = document.getElementById('messages');
                    const row = document.createElement('div');
                    row.className = `message-row ${msg.role === 'System' ? 'system-row' : 'theirs'}`;
                    
                    const meta = document.createElement('div');
                    meta.className = 'msg-meta';
                    // Sanitize user input by only setting text for names
                    const roleColor = (msg.role === 'System' || msg.role === 'Admin' || msg.role === 'Owner') ? (msg.role === 'System' ? 'red' : msg.role === 'Owner' ? '#ff3333' : '#ff6600') : var(--neon-blue);
                    
                    if (msg.role !== 'System') {
                        meta.innerHTML = `<span style="color: ${roleColor}; font-weight: bold;">${msg.user}</span> <span style="font-size: 0.8em; color: gray;">[${msg.timestamp}]</span>`;
                    }

                    const bubble = document.createElement('div');
                    bubble.className = `msg-bubble ${msg.role === 'System' ? 'system' : msg.role === 'Admin' || msg.role === 'Owner' ? 'admin' : 'public'}`;
                    bubble.innerText = msg.text; // Ensure text is set via innerText for safety

                    if (msg.role !== 'System') row.appendChild(meta);
                    row.appendChild(bubble);
                    
                    container.appendChild(row);
                    container.scrollTop = container.scrollHeight;
                });
                
                // --- Initial join attempt
                socket.emit('join', { name, password });
            } else {
                // If socket exists but login failed previously (shouldn't happen with the fix above)
                socket.emit('join', { name, password });
            }
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if(text) {
                socket.emit('chatMessage', text);
                input.value = '';
            }
        }

        // --- HUB Logic ---
        function loadHub() {
            const input = document.getElementById('hub-url-input');
            const iframe = document.getElementById('hub-iframe');
            let url = input.value.trim();

            if (url) {
                // Ensure protocol is present
                if (!url.match(/^https?:\/\//i)) {
                    url = 'http://' + url;
                }
                iframe.src = url;
            }
        }


        // --- DM Logic (The first half of your index.html) ---
        function updateDMLobby(users) {
            const list = document.getElementById('dm-lobby');
            list.innerHTML = '';
            users.forEach(u => {
                // Don't show self or system users
                if (u.id === socket.id || u.role === 'System') return; 

                const card = document.createElement('div');
                card.className = 'dm-user-card';
                // Using textContent for name for safety
                card.innerHTML = `<span>${u.name}</span><i class="fas fa-lock"></i>`;
                card.onclick = () => requestDM(u.id);
                list.appendChild(card);
            });
        }
        function requestDM(targetId) {
            showNotification("Requesting Secure Link...", "warning");
            socket.emit('dmRequest', targetId);
        }
        socket.on('incomingDMRequest', (data) => {
            incomingRequestFrom = data.fromId;
            document.getElementById('dm-req-text').innerText = `${data.name} is requesting a secure line.`;
            document.getElementById('dm-request-modal').style.display = 'block';
        });
        function acceptDM() { socket.emit('dmAccepted', incomingRequestFrom); document.getElementById('dm-request-modal').style.display = 'none'; }
        function rejectDM() { socket.emit('dmRejected', incomingRequestFrom); document.getElementById('dm-request-modal').style.display = 'none'; }

        // --- DM Reject Alert (FIXED BUG) ---
        socket.on('dmRejectedAlert', (msg) => {
            showNotification(msg, "error");
        });

        socket.on('dmStart', (data) => {
            currentDMPartnerId = data.withId;
            switchTab('dm');
            document.getElementById('dm-lobby').style.display = 'none';
            document.getElementById('dm-active-chat').style.display = 'flex';
            document.getElementById('dm-partner-name').innerText = `LINKED: ${data.name}`;
            document.getElementById('dm-messages').innerHTML = '';
            showNotification("SECURE CHANNEL ESTABLISHED", "warning");
        });

        function exitDM() {
            currentDMPartnerId = null;
            document.getElementById('dm-active-chat').style.display = 'none';
            document.getElementById('dm-lobby').style.display = 'grid';
        }

        function sendDM() {
            const input = document.getElementById('dm-input');
            const text = input.value.trim();
            if(text && currentDMPartnerId) { 
                socket.emit('privateMessage', { to: currentDMPartnerId, text: text }); 
                input.value = ''; 
                // Optimization: Client echoes message locally instead of waiting for server echo (optional)
            }
        }
        document.getElementById('dm-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendDM(); });

        socket.on('privateMsgReceive', (msg) => {
            const container = document.getElementById('dm-messages');
            const row = document.createElement('div');
            const isMe = msg.fromId === socket.id;
            row.className = `message-row ${isMe ? 'mine' : 'theirs'}`;
            const meta = document.createElement('div');
            meta.className = 'msg-meta';
            // Ensure name is only text
            meta.innerHTML = `<span style="color: var(--neon-purple);">${msg.name}</span>`;
            const bubble = document.createElement('div');
            bubble.className = 'msg-bubble dm-private';
            bubble.innerText = msg.text;
            row.appendChild(meta); row.appendChild(bubble);
            container.appendChild(row); container.scrollTop = container.scrollHeight;
        });

        // --- User List & Admin ---
        socket.on('userList', (users) => {
            const select = document.getElementById('user-select');
            if(select) {
                const currentVal = select.value;
                select.innerHTML = '<option value="">Select Target...</option>';
                users.forEach(u => {
                    // Only list non-System users
                    if (u.role !== 'System') {
                        const opt = document.createElement('option');
                        opt.value = u.name; // Note: For admin, banning by name is used, ideally this should be ID
                        opt.innerText = `${u.name} [${u.role}]`;
                        select.appendChild(opt);
                    }
                });
                select.value = currentVal;
            }
            const listContainer = document.getElementById('user-list');
            listContainer.innerHTML = '';
            users.forEach(u => {
                if (u.role === 'System') return;
                const div = document.createElement('div');
                div.className = 'user-item';
                let statusClass = 'status-chat';
                let statusText = u.status || 'In Comms';
                if(statusText.includes('Hub')) statusClass = 'status-hub';
                if(statusText.includes('Deck')) statusClass = 'status-admin';
                if(statusText.includes('Secure')) statusClass = 'status-dm';
                div.innerHTML = `<div class="status-dot ${statusClass}"></div><div class="user-info-group"><span style="font-weight:bold; color:#e0e0e0;">${u.name}</span><span class="user-status-text">${statusText}</span></div>`;
                listContainer.appendChild(div);
            });
            updateDMLobby(users);
        });

        function banUser() {
            const targetName = document.getElementById('user-select').value;
            if(targetName && confirm(`PERMANENT EXILE (BAN) ${targetName}?`)) socket.emit('adminAction', { type: 'ban_user', targetName: targetName });
        }
        function banWord() {
            const word = document.getElementById('ban-word-input').value.trim();
            if(word) { socket.emit('adminAction', { type: 'ban_word', word: word }); document.getElementById('ban-word-input').value = ''; }
        }
        function sendAnnouncement() {
            const text = document.getElementById('announce-input').value.trim();
            if(text) { socket.emit('adminAction', { type: 'announce', text: text }); document.getElementById('announce-input').value = ''; }
        }
        socket.on('announcement', (data) => {
            document.getElementById('announce-text').innerText = data.text;
            document.getElementById('announce-sender').innerText = `Broadcast: ${data.sender}`;
            document.getElementById('announcement-overlay').style.display = 'flex';
        });

        // --- Navigation ---
        window.switchTab = function(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            let status = 'Unknown';
            if(tabName === 'chat') { document.getElementById('chat-tab').classList.add('active'); status = 'In Comms'; }
            if(tabName === 'hub') { document.getElementById('hub-tab').classList.add('active'); status = 'Exploring Hub'; }
            if(tabName === 'dm') { document.getElementById('dm-tab').classList.add('active'); status = 'Secure Link'; }
            if(tabName === 'admin') { 
                const adminTab = document.getElementById('admin-tab');
                if (adminTab.style.display !== 'none') { // Only allow if tab is visible (role check)
                    adminTab.classList.add('active'); 
                    status = 'Command Deck'; 
                } else {
                    tabName = 'chat'; // Fallback if user tries to manually call switchTab('admin')
                }
            }

            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            if(tabName === 'chat') document.getElementById('chat-view').classList.add('active');
            if(tabName === 'hub') document.getElementById('hub-view').classList.add('active');
            if(tabName === 'dm') document.getElementById('dm-view').classList.add('active');
            if(tabName === 'admin') document.getElementById('admin-view').classList.add('active');

            if(socket && myData) socket.emit('updateStatus', status);
        }

        // --- SVG Background (REMOVED FOR PERFORMANCE) ---
        // The generateSpaceBackground function and its listeners have been removed.
        // The background is now handled by the static body/container CSS.

        // Initial setup
        // switchTab('chat'); // This will be called on loginSuccess
    </script>
</body>
</html>
