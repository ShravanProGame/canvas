<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Node // Uplink</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;500&display=swap');

        /* --- VARIABLES --- */
        :root {
            --neon-blue: #00ffff;
            --neon-purple: #d600ff; /* VIP */
            --neon-orange: #ffaa00; /* Admin */
            --neon-red: #ff3333;    /* Owner */
            --bg-dark: #050505;
            --panel-bg: rgba(10, 15, 20, 0.95);
            --border: 1px solid rgba(0, 255, 255, 0.3);
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg-dark); color: #e0e0e0; font-family: 'Roboto Mono', monospace; }

        /* --- BACKGROUND --- */
        #grid-bg {
            position: absolute; width: 100%; height: 100%; z-index: 0; pointer-events: none;
            background: linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* --- UI STRUCTURE --- */
        #app { display: none; width: 100vw; height: 100vh; display: flex; flex-direction: column; position: relative; z-index: 10; }
        
        /* HEADER */
        .header { height: 60px; border-bottom: var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: rgba(0,255,255,0.05); }
        .header-section { display: flex; gap: 5px; height: 100%; align-items: center; }
        
        .nav-btn {
            background: transparent; border: 1px solid transparent; color: #888;
            padding: 8px 15px; cursor: pointer; font-family: 'Orbitron'; font-size: 0.8rem;
            text-transform: uppercase; transition: 0.3s; clip-path: polygon(10% 0, 100% 0, 100% 100%, 0% 100%, 0% 30%);
        }
        .nav-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .nav-btn.active { background: rgba(0, 255, 255, 0.15); color: var(--neon-blue); border-bottom: 2px solid var(--neon-blue); }
        .nav-btn.channel-btn { border-color: rgba(0,255,255,0.2); }
        
        /* MAIN BODY */
        .main-body { flex: 1; display: flex; overflow: hidden; }
        
        /* SIDEBAR (User List) */
        .sidebar { width: 260px; border-right: var(--border); background: rgba(0,0,0,0.5); display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; color: var(--neon-blue); font-family: 'Orbitron'; border-bottom: var(--border); letter-spacing: 1px; }
        #user-list { flex: 1; overflow-y: auto; padding: 10px; }
        .user-card { padding: 8px; margin-bottom: 5px; background: rgba(255,255,255,0.05); border-radius: 4px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .user-card:hover { background: rgba(255,255,255,0.1); }

        /* BOTTOM BAR (My Profile / Owner Trigger) */
        .bottom-bar { height: 50px; border-top: var(--border); background: #000; display: flex; align-items: center; padding: 0 15px; cursor: pointer; transition: 0.3s; }
        .bottom-bar:hover { background: #111; }
        .my-status-dot { width: 10px; height: 10px; border-radius: 50%; background: #00ff00; box-shadow: 0 0 5px #00ff00; margin-right: 10px; }

        /* VIEW AREA */
        .view-container { flex: 1; display: flex; flex-direction: column; position: relative; background: rgba(0,0,0,0.2); }
        .view-panel { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        .view-panel.active { display: flex; }

        /* CHAT STYLES */
        #chat-history { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .msg-row { display: flex; flex-direction: column; max-width: 85%; }
        .msg-row.mine { align-self: flex-end; align-items: flex-end; }
        
        .msg-bubble { padding: 10px 15px; border-radius: 6px; background: #1a1a1a; border-left: 3px solid #666; word-break: break-word; position: relative; }
        .msg-info { font-size: 0.7rem; color: #666; margin-bottom: 4px; display: flex; gap: 8px; align-items: center; }
        
        /* BADGES */
        .badge { font-size: 0.6rem; padding: 2px 5px; border-radius: 3px; font-weight: bold; font-family: 'Orbitron'; text-transform: uppercase; border: 1px solid; }
        .badge-owner { color: var(--neon-red); border-color: var(--neon-red); text-shadow: 0 0 5px var(--neon-red); }
        .badge-admin { color: var(--neon-orange); border-color: var(--neon-orange); text-shadow: 0 0 5px var(--neon-orange); }
        .badge-vip { color: var(--neon-purple); border-color: var(--neon-purple); text-shadow: 0 0 5px var(--neon-purple); }
        .badge-user { display: none; }

        .typing-indicator { height: 20px; padding-left: 20px; font-size: 0.7rem; color: var(--neon-blue); font-style: italic; opacity: 0; transition: opacity 0.3s; }

        .input-area { padding: 15px; background: rgba(0,0,0,0.8); border-top: var(--border); display: flex; gap: 10px; }
        input { flex: 1; background: #111; border: 1px solid #444; color: white; padding: 10px; font-family: 'Roboto Mono'; outline: none; }
        input:focus { border-color: var(--neon-blue); }
        button.send-btn { background: var(--neon-blue); color: #000; border: none; font-weight: bold; cursor: pointer; padding: 0 20px; font-family: 'Orbitron'; }

        /* DM LAYOUT (Sidebar within View) */
        .dm-layout { display: flex; height: 100%; }
        .dm-sidebar { width: 200px; border-right: var(--border); background: rgba(0,0,0,0.3); overflow-y: auto; }
        .dm-chat-area { flex: 1; display: flex; flex-direction: column; background: #000; }
        .active-dm-btn { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; color: var(--neon-purple); }
        .active-dm-btn:hover { background: rgba(214, 0, 255, 0.1); }
        .active-dm-btn.selected { background: rgba(214, 0, 255, 0.2); border-left: 3px solid var(--neon-purple); }

        /* MODALS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: var(--panel-bg); border: 2px solid var(--neon-blue); padding: 30px; width: 400px; display: flex; flex-direction: column; gap: 15px; text-align: center; box-shadow: 0 0 30px rgba(0,255,255,0.1); }

        /* OWNER PANEL */
        #owner-panel { border-color: var(--neon-red); text-align: left; }
        .ip-list-item { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #333; font-size: 0.8rem; }
        
        /* ADMIN PANEL NEW LAYOUT */
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .admin-card { border: 1px solid var(--neon-orange); padding: 15px; background: rgba(255, 170, 0, 0.05); }

    </style>
</head>
<body>
    <div id="grid-bg"></div>

    <div id="login-modal" class="modal" style="display: flex;">
        <div class="modal-box">
            <h1 style="font-family:'Orbitron'; color:var(--neon-blue); margin:0;">GALACTIC NODE</h1>
            <input type="text" id="username" placeholder="Designation (Name)">
            <input type="password" id="password" placeholder="Clearance Code (Optional)">
            <button class="send-btn" style="padding:15px;" onclick="login()">INITIALIZE UPLINK</button>
            <div id="login-error" style="color:red; font-size:0.8rem;"></div>
        </div>
    </div>

    <div id="user-details-modal" class="modal">
        <div class="modal-box" style="border-color:var(--neon-red);">
            <h2 style="color:var(--neon-red); font-family:'Orbitron';">TARGET ANALYSIS</h2>
            <div id="detail-content" style="text-align:left; font-size:0.9rem; line-height:1.6;"></div>
            <button class="send-btn" style="background:var(--neon-red); color:white;" onclick="closeModal('user-details-modal')">CLOSE</button>
        </div>
    </div>

    <div id="owner-panel-modal" class="modal">
        <div class="modal-box" id="owner-panel">
            <h2 style="color:var(--neon-red); font-family:'Orbitron'; margin-top:0;">OVERSEER CONTROL</h2>
            <div style="font-size:0.8rem; color:#888;">BANNED IP REGISTRY</div>
            <div id="banned-ip-list" style="height:150px; overflow-y:auto; border:1px solid #333; margin-bottom:10px;"></div>
            <button class="send-btn" style="background:var(--neon-red); color:white; width:100%;" onclick="closeModal('owner-panel-modal')">CLOSE DECK</button>
        </div>
    </div>

    <div id="app" style="display:none;">
        
        <div class="header">
            <div class="header-section">
                <button class="nav-btn channel-btn active" onclick="switchChannel('bridge')">MAIN BRIDGE</button>
                <button class="nav-btn channel-btn" onclick="switchChannel('holodeck')">HOLO-DECK</button>
                <button class="nav-btn channel-btn" onclick="switchChannel('simulation')">SIMULATIONS</button>
            </div>
            <div class="header-section">
                <button class="nav-btn" onclick="switchView('hub')"><i class="fas fa-satellite"></i> HUB</button>
                <button class="nav-btn" onclick="switchView('dm')"><i class="fas fa-lock"></i> SECURE LINK</button>
                <button class="nav-btn" id="admin-btn" style="display:none; color:var(--neon-orange);" onclick="switchView('admin')"><i class="fas fa-shield-alt"></i> ADMIN</button>
            </div>
        </div>

        <div class="main-body">
            <div class="sidebar">
                <div class="sidebar-header">ACTIVE AGENTS</div>
                <div id="user-list"></div>
                <div class="bottom-bar" id="my-profile-bar" onclick="openProfile()">
                    <div class="my-status-dot"></div>
                    <div style="display:flex; flex-direction:column;">
                        <span id="my-name" style="font-weight:bold; font-size:0.9rem;">LOADING...</span>
                        <span id="my-role" style="font-size:0.7rem; color:#888;">CONNECTING</span>
                    </div>
                </div>
            </div>

            <div class="view-container">
                
                <div id="view-chat" class="view-panel active">
                    <div id="chat-history"></div>
                    <div id="typing-indicator" class="typing-indicator">User is transmitting...</div>
                    <div class="input-area">
                        <input type="text" id="chat-input" placeholder="Broadcast message...">
                        <button class="send-btn" onclick="sendChat()">TRANSMIT</button>
                    </div>
                </div>

                <div id="view-hub" class="view-panel" style="padding:20px;">
                    <h2 style="font-family:'Orbitron'; color:var(--neon-blue);">DEEP SPACE HUB</h2>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <button class="nav-btn" style="border:1px solid var(--neon-blue);" onclick="document.getElementById('hub-frame').src='https://amp.nov.su'">PROXY</button>
                        <button class="nav-btn" style="border:1px solid var(--neon-blue);" onclick="document.getElementById('hub-frame').src='https://spaceracer.onrender.com'">GAME</button>
                        <button class="nav-btn" style="border:1px solid red; color:red;" onclick="document.getElementById('hub-frame').src='about:blank'">TERMINATE</button>
                    </div>
                    <iframe id="hub-frame" src="about:blank" style="flex:1; border:none; background:#000;" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
                </div>

                <div id="view-admin" class="view-panel" style="padding:30px;">
                    <h2 style="font-family:'Orbitron'; color:var(--neon-orange);">COMMAND DECK</h2>
                    <div class="admin-grid">
                        <div class="admin-card">
                            <h3 style="color:var(--neon-orange); margin-top:0;">EXILE USER</h3>
                            <input type="text" id="ban-target" placeholder="User Designation">
                            <button class="send-btn" style="background:var(--neon-orange); margin-top:10px; width:100%; color:black;" onclick="adminAction('ban_user')">EXECUTE BAN</button>
                        </div>
                        <div class="admin-card">
                            <h3 style="color:var(--neon-orange); margin-top:0;">SYSTEM BROADCAST</h3>
                            <input type="text" id="announce-text" placeholder="Message content">
                            <button class="send-btn" style="background:var(--neon-orange); margin-top:10px; width:100%; color:black;" onclick="adminAction('announce')">BROADCAST</button>
                        </div>
                    </div>
                </div>

                <div id="view-dm" class="view-panel">
                    <div class="dm-layout">
                        <div class="dm-sidebar">
                            <div style="padding:15px; border-bottom:var(--border); font-family:'Orbitron'; color:var(--neon-purple);">ENCRYPTED LINKS</div>
                            <div style="padding:10px;">
                                <select id="dm-select-target" style="width:100%; background:#111; color:white; padding:5px; margin-bottom:5px;">
                                    <option value="">Select Target...</option>
                                </select>
                                <button class="send-btn" style="background:var(--neon-purple); width:100%; color:white;" onclick="startNewDM()">OPEN LINK</button>
                            </div>
                            <div id="active-dm-list"></div>
                        </div>
                        <div class="dm-chat-area">
                            <div id="dm-header" style="padding:15px; border-bottom:1px solid #333; color:var(--neon-purple); display:none;">
                                LINKED: <span id="dm-partner-name" style="font-weight:bold;">NONE</span>
                            </div>
                            <div id="dm-history" style="flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:8px;"></div>
                            <div id="dm-input-container" class="input-area" style="display:none; border-top:1px solid var(--neon-purple);">
                                <input type="text" id="dm-input" style="border-color:var(--neon-purple);" placeholder="Encrypted transmission...">
                                <button class="send-btn" style="background:var(--neon-purple); color:white;" onclick="sendDM()">SEND</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="dm-popup" class="modal">
        <div class="modal-box" style="border-color:var(--neon-purple); width:300px;">
            <h2 style="color:var(--neon-purple); font-family:'Orbitron';">INCOMING SIGNAL</h2>
            <p id="dm-popup-text">User wants to connect.</p>
            <div style="display:flex; gap:10px;">
                <button class="send-btn" style="background:#00ff00; flex:1;" onclick="acceptDM()">ACCEPT</button>
                <button class="send-btn" style="background:red; color:white; flex:1;" onclick="rejectDM()">DENY</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myUser = null;
        let currentChannel = 'bridge';
        let typingTimeout;
        
        // DM State
        let activeDMs = {}; // { userId: { name: 'Bob', messages: [] } }
        let currentDMId = null;
        let pendingDM = null;

        // --- LOGIN ---
        function login() {
            const name = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            if (name) socket.emit('join', { name, password: pass });
        }
        socket.on('loginError', msg => document.getElementById('login-error').innerText = msg);
        
        socket.on('loginSuccess', data => {
            myUser = data.user;
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            
            // Setup Profile Bar
            document.getElementById('my-name').innerText = myUser.name;
            document.getElementById('my-role').innerText = myUser.role.toUpperCase();
            
            if (myUser.role === 'Admin' || myUser.role === 'Owner') {
                document.getElementById('admin-btn').style.display = 'block';
            }
        });

        socket.on('banAlert', msg => {
            document.body.innerHTML = `<h1 style="color:red; text-align:center; margin-top:20%; font-family:monospace;">${msg}</h1>`;
        });

        // --- CHANNELS & HISTORY ---
        function switchChannel(channel) {
            currentChannel = channel;
            document.querySelectorAll('.channel-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Clear current chat view
            document.getElementById('chat-history').innerHTML = '';
            
            // Switch view to chat if not already
            switchView('chat'); 
            
            socket.emit('switchChannel', channel);
        }

        socket.on('loadHistory', history => {
            document.getElementById('chat-history').innerHTML = '';
            history.forEach(renderMessage);
        });

        // --- CHAT LOGIC ---
        function sendChat() {
            const input = document.getElementById('chat-input');
            const text = input.value;
            if (text) {
                socket.emit('chatMessage', { text, channel: currentChannel });
                input.value = '';
                socket.emit('stopTyping', currentChannel);
            }
        }
        
        // Typing Indicators
        document.getElementById('chat-input').addEventListener('input', () => {
            socket.emit('typing', currentChannel);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => socket.emit('stopTyping', currentChannel), 1000);
        });

        socket.on('userTyping', data => {
            if (data.channel === currentChannel) {
                const ind = document.getElementById('typing-indicator');
                ind.innerText = `${data.user} is transmitting...`;
                ind.style.opacity = 1;
            }
        });
        socket.on('userStopTyping', data => {
            if (data.channel === currentChannel) document.getElementById('typing-indicator').style.opacity = 0;
        });

        socket.on('message', renderMessage);

        function renderMessage(msg) {
            // Filter by channel if it's a channel message
            if (msg.channel && msg.channel !== currentChannel) return;

            const div = document.createElement('div');
            const isMe = myUser && msg.user === myUser.name;
            div.className = `msg-row ${isMe ? 'mine' : 'theirs'}`;
            
            // Role Colors & Badges
            let color = '#00ffff';
            let badgeClass = 'badge-user';
            
            if (msg.role === 'Owner') { color = '#ff3333'; badgeClass = 'badge-owner'; }
            if (msg.role === 'Admin') { color = '#ffaa00'; badgeClass = 'badge-admin'; }
            if (msg.role === 'VIP')   { color = '#d600ff'; badgeClass = 'badge-vip'; }
            if (msg.role === 'System') color = '#00ff00';

            const badgeHtml = msg.role !== 'User' && msg.role !== 'System' ? `<span class="badge ${badgeClass}">${msg.role}</span>` : '';
            
            div.innerHTML = `
                <div class="msg-info" style="justify-content: ${isMe ? 'flex-end' : 'flex-start'}">
                    ${badgeHtml} <span style="color:${color}; font-weight:bold;">${msg.user}</span> <span>${msg.timestamp}</span>
                </div>
                <div class="msg-bubble" style="border-left-color:${color}">${msg.text}</div>
            `;
            
            const container = document.getElementById('chat-history');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- USER LIST ---
        socket.on('userList', users => {
            const list = document.getElementById('user-list');
            const dmSelect = document.getElementById('dm-select-target');
            
            list.innerHTML = '';
            dmSelect.innerHTML = '<option value="">Select Target...</option>';

            users.forEach(u => {
                // Sidebar List (Hide Self)
                if (u.name !== myUser.name) {
                    const el = document.createElement('div');
                    el.className = 'user-card';
                    el.innerHTML = `<div class="my-status-dot" style="background:${u.role==='Owner'?'red':u.role==='Admin'?'orange':'#00ff00'}"></div> ${u.name} <span class="badge badge-${u.role.toLowerCase()}">${u.role}</span>`;
                    
                    // Owner Feature: Click to view details
                    if (myUser.role === 'Owner') {
                        el.onclick = () => socket.emit('ownerAction', { type: 'getDetails', targetId: u.id });
                    }
                    list.appendChild(el);

                    // DM Select List
                    const opt = document.createElement('option');
                    opt.value = u.id;
                    opt.innerText = u.name;
                    dmSelect.appendChild(opt);
                }
            });
        });

        // --- OWNER FEATURES ---
        function openProfile() {
            if (myUser.role === 'Owner') {
                document.getElementById('owner-panel-modal').style.display = 'flex';
            }
        }

        socket.on('userDetails', user => {
            document.getElementById('detail-content').innerHTML = `
                <strong>IDENTITY:</strong> ${user.name}<br>
                <strong>ROLE:</strong> ${user.role}<br>
                <strong>IP ADDRESS:</strong> ${user.ip}<br>
                <strong>STATUS:</strong> ${user.status}<br>
                <strong>ID:</strong> ${user.id}
            `;
            document.getElementById('user-details-modal').style.display = 'flex';
        });

        socket.on('updateBanList', ips => {
            const list = document.getElementById('banned-ip-list');
            list.innerHTML = '';
            ips.forEach(ip => {
                const row = document.createElement('div');
                row.className = 'ip-list-item';
                row.innerHTML = `<span>${ip}</span> <button onclick="unbanIP('${ip}')" style="background:transparent; border:none; color:#00ff00; cursor:pointer;">UNBAN</button>`;
                list.appendChild(row);
            });
        });

        function unbanIP(ip) {
            socket.emit('ownerAction', { type: 'unbanIP', ip });
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- ADMIN ---
        function adminAction(type) {
            const targetName = document.getElementById('ban-target').value;
            const announceText = document.getElementById('announce-text').value;
            if (type === 'ban_user' && targetName) socket.emit('adminAction', { type, targetName });
            if (type === 'announce' && announceText) socket.emit('adminAction', { type, text: announceText });
        }
        
        socket.on('announcement', data => alert(`BROADCAST FROM ${data.sender}: ${data.text}`));

        // --- DM LOGIC (Multiple) ---
        function startNewDM() {
            const targetId = document.getElementById('dm-select-target').value;
            if (targetId) socket.emit('dmRequest', targetId);
        }

        socket.on('incomingDMRequest', data => {
            pendingDM = data.fromId;
            document.getElementById('dm-popup-text').innerText = `${data.name} requesting secure link.`;
            document.getElementById('dm-popup').style.display = 'flex';
        });

        function acceptDM() { socket.emit('dmAccepted', pendingDM); document.getElementById('dm-popup').style.display = 'none'; }
        function rejectDM() { document.getElementById('dm-popup').style.display = 'none'; }

        socket.on('dmStart', data => {
            const partnerId = data.withId;
            if (!activeDMs[partnerId]) {
                activeDMs[partnerId] = { name: data.name, messages: [] };
                renderActiveDMList();
            }
            switchToDM(partnerId);
        });

        function renderActiveDMList() {
            const container = document.getElementById('active-dm-list');
            container.innerHTML = '';
            Object.keys(activeDMs).forEach(id => {
                const btn = document.createElement('div');
                btn.className = 'active-dm-btn';
                if (id === currentDMId) btn.classList.add('selected');
                btn.innerText = activeDMs[id].name;
                btn.onclick = () => switchToDM(id);
                container.appendChild(btn);
            });
        }

        function switchToDM(id) {
            currentDMId = id;
            renderActiveDMList();
            const dm = activeDMs[id];
            
            document.getElementById('dm-header').style.display = 'block';
            document.getElementById('dm-partner-name').innerText = dm.name;
            document.getElementById('dm-input-container').style.display = 'flex';
            
            // Render History
            const hist = document.getElementById('dm-history');
            hist.innerHTML = '';
            dm.messages.forEach(renderPrivateMessage);
        }

        socket.on('privateMsgReceive', msg => {
            // Determine partner ID (if I sent it, partner is 'to', if I received, partner is 'fromId') 
            // NOTE: Logic simplified here, assuming 'fromId' is partner if not me.
            // But we need to find which DM conversation this belongs to.
            
            let partnerId = (msg.fromId === socket.id) ? currentDMId : msg.fromId; // Fallback for sender
            
            // If receiving from someone new
            if (msg.fromId !== socket.id && !activeDMs[msg.fromId]) {
                activeDMs[msg.fromId] = { name: msg.name, messages: [] };
                renderActiveDMList();
            }
            
            // Store message
            const targetDM = (msg.fromId === socket.id) ? activeDMs[currentDMId] : activeDMs[msg.fromId];
            if (targetDM) {
                targetDM.messages.push(msg);
                // If currently viewing this DM, render it
                if ((msg.fromId === socket.id && currentDMId) || (msg.fromId === currentDMId)) {
                    renderPrivateMessage(msg);
                }
            }
        });

        function renderPrivateMessage(msg) {
            const div = document.createElement('div');
            const isMe = msg.fromId === socket.id;
            div.className = `msg-row ${isMe ? 'mine' : 'theirs'}`;
            div.innerHTML = `
                <div class="msg-info" style="color:var(--neon-purple);">${isMe ? 'ME' : msg.name}</div>
                <div class="msg-bubble" style="border-left-color:var(--neon-purple); background:#1a0520;">${msg.text}</div>
            `;
            document.getElementById('dm-history').appendChild(div);
        }

        function sendDM() {
            const txt = document.getElementById('dm-input').value;
            if (txt && currentDMId) {
                socket.emit('privateMessage', { to: currentDMId, text: txt });
                document.getElementById('dm-input').value = '';
            }
        }

        // --- UTILS ---
        function switchView(viewName) {
            document.querySelectorAll('.view-panel').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            
            // Channel buttons only active in chat view
            if (viewName !== 'bridge' && viewName !== 'holodeck' && viewName !== 'simulation') {
                // Keeping visual state logic simple
            }
        }
    </script>
</body>
</html>
