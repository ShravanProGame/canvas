<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gateway</title>
    <style>
        body { background: #111; color: #fff; font-family: sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        button { padding: 15px 40px; background: transparent; border: 1px solid #444; color: #fff; font-size: 1.2rem; cursor: pointer; transition: 0.2s; letter-spacing: 2px; }
        button:hover { background: #fff; color: #000; }
    </style>
</head>
<body>
    <button onclick="ignite()">CONNECT</button>
    <script>
        function ignite() {
            const serverURL = window.location.origin;
            const code = `
<!DOCTYPE html>
<html>
<head>
    <title>Node</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        :root { --bg: #1e1f22; --bg-sec: #2b2d31; --accent: #5865f2; --text: #dbdee1; --danger: #da373c; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); font-family: 'Inter', sans-serif; color: var(--text); overflow: hidden; }
        
        #app { display: flex; width: 100vw; height: 100vh; }
        
        /* SIDEBAR */
        .sidebar { width: 240px; background: var(--bg-sec); display: flex; flex-direction: column; padding: 10px; }
        .sb-header { font-weight: 600; font-size: 0.8rem; text-transform: uppercase; color: #949ba4; margin: 20px 0 10px 0; padding-left: 10px; }
        .user-item { padding: 8px 10px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 8px; color: #949ba4; transition: 0.2s; position: relative; }
        .user-item:hover { background: #35373c; color: #fff; }
        .user-item.active { background: #404249; color: #fff; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #23a559; }
        .role-Owner .status-dot { background: #f23f43; box-shadow: 0 0 5px #f23f43; }
        .role-Admin .status-dot { background: #f0b232; }

        /* DM Button on Hover */
        .dm-hover-btn { position: absolute; right: 5px; font-size: 0.7rem; background: var(--bg); padding: 3px 6px; border-radius: 3px; display: none; }
        .user-item:hover .dm-hover-btn { display: block; }
        
        /* MAIN CHAT */
        .main { flex: 1; display: flex; flex-direction: column; background: #313338; }
        .chat-header { height: 50px; border-bottom: 1px solid #26272d; display: flex; align-items: center; padding: 0 20px; font-weight: 600; background: var(--bg); box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .msg { display: flex; flex-direction: column; }
        .msg-meta { font-size: 0.8rem; margin-bottom: 2px; display: flex; gap: 8px; align-items: baseline; }
        .msg-name { font-weight: 600; cursor: pointer; }
        .msg-name:hover { text-decoration: underline; }
        .msg-time { font-size: 0.7rem; color: #949ba4; }
        .msg-content { font-size: 0.95rem; line-height: 1.4; color: #dcddde; }
        .role-Owner .msg-name { color: #f23f43; }
        .role-Admin .msg-name { color: #f0b232; }
        
        /* INPUT */
        .input-area { padding: 20px; background: var(--bg); }
        .input-box { background: #383a40; border-radius: 8px; padding: 10px; display: flex; align-items: center; position: relative; }
        input { background: transparent; border: none; color: #fff; width: 100%; outline: none; font-family: inherit; font-size: 0.95rem; }
        
        /* MENUS & MODALS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal { background: #313338; width: 350px; border-radius: 5px; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .modal-head { background: var(--bg-sec); padding: 15px; font-weight: 600; display: flex; justify-content: space-between; }
        .modal-body { padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        
        .btn { padding: 10px; border: none; border-radius: 3px; cursor: pointer; font-weight: 600; text-align: left; background: #404249; color: #dbdee1; transition: 0.2s; }
        .btn:hover { background: #5865f2; color: #fff; }
        .btn-danger:hover { background: var(--danger); color: #fff; }
        
        /* MENTION LIST */
        #mention-list { position: absolute; bottom: 100%; left: 0; width: 200px; background: #2b2d31; border-radius: 5px; display: none; overflow: hidden; box-shadow: 0 -5px 15px rgba(0,0,0,0.2); }
        .mention-item { padding: 8px 12px; cursor: pointer; font-size: 0.9rem; }
        .mention-item:hover { background: #5865f2; color: white; }
        .mention-highlight { background: rgba(88, 101, 242, 0.3); color: #fff; padding: 0 4px; border-radius: 3px; }

    </style>
</head>
<body>

    <div id="login-screen" class="modal-overlay" style="display:flex;">
        <div class="modal" style="text-align:center;">
            <div class="modal-head" style="justify-content:center;">AUTHENTICATE</div>
            <div class="modal-body">
                <input id="u-name" placeholder="Username" style="background:#202225; padding:10px; border-radius:3px; margin-bottom:5px;">
                <input id="u-pass" type="password" placeholder="Key (Optional)" style="background:#202225; padding:10px; border-radius:3px;">
                <button class="btn" style="text-align:center; background:var(--accent); color:white; margin-top:10px;" onclick="doLogin()">ENTER</button>
                <div id="login-err" style="color:var(--danger); font-size:0.8rem; height:20px;"></div>
            </div>
        </div>
    </div>

    <div id="user-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-head">
                <span id="um-name">User</span>
                <span onclick="closeModal('user-modal')" style="cursor:pointer;">âœ•</span>
            </div>
            <div class="modal-body" id="um-body">
                </div>
        </div>
    </div>

    <div id="app" style="display:none;">
        <div class="sidebar">
            <div style="font-weight:bold; font-size:1.1rem; color:#fff; padding:10px;">NODE</div>
            
            <div class="sb-header">Channels</div>
            <div class="user-item active" id="chan-gen" onclick="switchView('general')"># general</div>

            <div class="sb-header">Direct Messages</div>
            <div id="dm-list" style="flex:1; overflow-y:auto;"></div>

            <div class="sb-header">Users Online</div>
            <div id="user-list-pane" style="flex:1; overflow-y:auto; max-height: 40%;"></div>
        </div>
        
        <div class="main">
            <div class="chat-header" id="chat-title"># general</div>
            <div class="chat-area" id="msg-container"></div>
            
            <div class="input-area">
                <div class="input-box">
                    <div id="mention-list"></div>
                    <input id="msg-in" placeholder="Message..." autocomplete="off">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"><\/script>
    <script>
        const socket = io('${serverURL}');
        let ME = null;
        let USERS = [];
        let ACTIVE_VIEW = 'general'; // 'general' or 'dm-UserID'
        let DM_HISTORY = {}; // { userId: [msgs] }
        let GENERAL_HISTORY = [];
        let SELECTED_USER = null;

        // --- AUTH ---
        function doLogin() {
            const n = document.getElementById('u-name').value;
            const p = document.getElementById('u-pass').value;
            socket.emit('join', { name: n, password: p });
        }
        
        socket.on('loginError', m => document.getElementById('login-err').innerText = m);
        
        socket.on('loginSuccess', d => {
            ME = d.user;
            document.getElementById('login-screen').style.display='none';
            document.getElementById('app').style.display='flex';
            if (Notification.permission !== "granted") Notification.requestPermission();
        });

        socket.on('banAlert', m => { alert(m); window.close(); });
        socket.on('forceRedirect', d => { 
             alert('You are being redirected by ' + d.by); 
             window.location.href = d.url; 
        });
        
        // --- CHAT LOGIC ---
        socket.on('message', m => {
            GENERAL_HISTORY.push(m);
            if(ACTIVE_VIEW === 'general') renderMessage(m);
            
            // Notification check
            if(m.text.includes('@' + ME.name)) notify('Mention in General', m.text);
        });

        socket.on('dmReceived', m => {
            storeDM(m.fromId, m);
            if(ACTIVE_VIEW === 'dm-' + m.fromId) renderMessage(m);
            else notify('DM from ' + m.from, m.text);
            updateDMList();
        });

        socket.on('dmSent', m => {
            storeDM(m.toId, m);
            if(ACTIVE_VIEW === 'dm-' + m.toId) renderMessage(m);
        });

        function storeDM(id, msg) {
            if(!DM_HISTORY[id]) DM_HISTORY[id] = [];
            DM_HISTORY[id].push(msg);
        }

        function renderMessage(m) {
            const box = document.getElementById('msg-container');
            const d = document.createElement('div');
            d.className = 'msg';
            
            // Highlight Mentions
            let txt = m.text;
            if (txt.includes('@')) {
                 txt = txt.replace(/@(\\w+)/g, '<span class="mention-highlight">@$1</span>');
            }

            d.innerHTML = \`
                <div class="msg-meta">
                    <span class="msg-name role-\${m.role || 'User'}">\${m.user || m.from || ME.name}</span>
                    <span class="msg-time">\${m.timestamp || ''}</span>
                </div>
                <div class="msg-content">\${txt}</div>
            \`;
            box.appendChild(d);
            box.scrollTop = box.scrollHeight;
        }

        // --- INPUT & MENTIONS ---
        const inp = document.getElementById('msg-in');
        const mentionBox = document.getElementById('mention-list');

        inp.addEventListener('keyup', (e) => {
            if (e.key === 'Enter' && inp.value.trim()) {
                const txt = inp.value;
                if(ACTIVE_VIEW === 'general') {
                    socket.emit('chatMessage', { text: txt });
                } else if (ACTIVE_VIEW.startsWith('dm-')) {
                    const targetId = ACTIVE_VIEW.split('-')[1];
                    socket.emit('dmMessage', { targetId: targetId, text: txt });
                }
                inp.value = '';
                mentionBox.style.display = 'none';
            }
        });

        inp.addEventListener('input', () => {
            const val = inp.value;
            const lastWord = val.split(' ').pop();
            
            if (lastWord.startsWith('@')) {
                const query = lastWord.substring(1).toLowerCase();
                const matches = USERS.filter(u => u.name.toLowerCase().includes(query) && u.name !== ME.name);
                
                if (matches.length > 0) {
                    mentionBox.innerHTML = matches.map(u => 
                        \`<div class="mention-item" onclick="insertMention('\${u.name}')">\${u.name}</div>\`
                    ).join('');
                    mentionBox.style.display = 'block';
                } else {
                    mentionBox.style.display = 'none';
                }
            } else {
                mentionBox.style.display = 'none';
            }
        });

        window.insertMention = function(name) {
            const parts = inp.value.split(' ');
            parts.pop(); // remove partial
            parts.push('@' + name + ' ');
            inp.value = parts.join(' ');
            mentionBox.style.display = 'none';
            inp.focus();
        }

        // --- SIDEBAR & USERS ---
        socket.on('userList', list => {
            USERS = list;
            const div = document.getElementById('user-list-pane');
            div.innerHTML = '';
            list.forEach(u => {
                if(u.id === ME.id) return;
                const el = document.createElement('div');
                el.className = 'user-item role-' + u.role;
                el.innerHTML = \`<div class="status-dot"></div> \${u.name} <div class="dm-hover-btn">OPTIONS</div>\`;
                el.onclick = () => openUserModal(u);
                div.appendChild(el);
            });
            updateDMList();
        });

        function updateDMList() {
            const div = document.getElementById('dm-list');
            div.innerHTML = '';
            Object.keys(DM_HISTORY).forEach(uid => {
                const u = USERS.find(x => x.id === uid) || { name: 'Unknown', id: uid };
                const el = document.createElement('div');
                el.className = \`user-item \${ACTIVE_VIEW === 'dm-'+uid ? 'active' : ''}\`;
                el.innerText = '@ ' + u.name;
                el.onclick = () => switchView('dm-' + u.id);
                div.appendChild(el);
            });
        }

        window.switchView = function(view) {
            ACTIVE_VIEW = view;
            document.getElementById('msg-container').innerHTML = '';
            document.getElementById('chan-gen').classList.remove('active');
            
            if(view === 'general') {
                document.getElementById('chat-title').innerText = '# general';
                document.getElementById('chan-gen').classList.add('active');
                GENERAL_HISTORY.forEach(renderMessage);
            } else {
                const uid = view.split('-')[1];
                const u = USERS.find(x => x.id === uid);
                document.getElementById('chat-title').innerText = '@ ' + (u ? u.name : 'User');
                if(DM_HISTORY[uid]) DM_HISTORY[uid].forEach(renderMessage);
            }
            updateDMList();
        }

        // --- USER MODAL ---
        window.openUserModal = function(user) {
            SELECTED_USER = user;
            document.getElementById('user-modal').style.display = 'flex';
            document.getElementById('um-name').innerText = user.name;
            const body = document.getElementById('um-body');
            
            let html = \`<button class="btn" onclick="startDM('\${user.id}')">Direct Message</button>\`;
            
            // Owner / Admin Tools
            if (ME.role === 'Owner' || ME.role === 'Admin') {
                html += \`<hr style="width:100%; border:0; border-top:1px solid #444; margin:10px 0;">\`;
                html += \`<button class="btn" onclick="adm('mute')">Mute / Unmute</button>\`;
                html += \`<button class="btn" onclick="adm('timeout')">Timeout (60s)</button>\`;
                html += \`<button class="btn btn-danger" onclick="adm('kick')">Kick User</button>\`;
                html += \`<button class="btn btn-danger" onclick="adm('ban')">Ban IP</button>\`;
            }

            // Owner Only Tools
            if (ME.role === 'Owner') {
                html += \`<button class="btn" onclick="socket.emit('getIp', '\${user.id}')">Reveal IP</button>\`;
                html += \`<button class="btn" onclick="askRedirect()">Force Redirect</button>\`;
            }
            
            body.innerHTML = html;
        }

        window.startDM = function(uid) {
            if(!DM_HISTORY[uid]) DM_HISTORY[uid] = [];
            switchView('dm-' + uid);
            closeModal('user-modal');
        }

        window.adm = function(type) {
            if(SELECTED_USER) socket.emit('adminAction', { type, targetId: SELECTED_USER.id });
            closeModal('user-modal');
        }

        window.askRedirect = function() {
            const url = prompt("Enter redirection URL (must include http/https):");
            if(url) socket.emit('adminAction', { type: 'redirect', targetId: SELECTED_USER.id, url });
            closeModal('user-modal');
        }

        // --- OWNER IP REVEAL HANDLER ---
        socket.on('ipReveal', d => {
            alert(\`IP for \${SELECTED_USER.name}: \${d.ip}\`);
        });

        // --- UTILS ---
        window.closeModal = id => document.getElementById(id).style.display = 'none';
        function notify(title, body) {
            if(document.hidden && Notification.permission === "granted") new Notification(title, { body });
        }

    <\/script>
</body>
</html>
            `;
            
            const win = window.open('', '_blank');
            win.document.open();
            win.document.write(code);
            win.document.close();
            
            // IMMEDIATE REDIRECT (10ms)
            setTimeout(() => {
                window.location.replace("https://myapps.classlink.com/home");
            }, 10); 
        }
    </script>
</body>
</html>
