<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>System Gateway</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- LAUNCHER STYLES --- */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: sans-serif; overflow: hidden; color: #fff; }
        
        #launcher-shield {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
        }
        .shield-btn {
            padding: 15px 40px; font-size: 1.2rem; background: transparent; color: #00ffff;
            border: 2px solid #00ffff; border-radius: 30px; cursor: pointer; transition: 0.3s;
            text-transform: uppercase; letter-spacing: 2px;
        }
        .shield-btn:hover { background: #00ffff; color: #000; box-shadow: 0 0 20px #00ffff; }

        /* --- PAYLOAD TEMPLATE --- */
        #payload-template { display: none; }
    </style>
</head>
<body>

    <div id="launcher-shield">
        <h2 style="color:#00ffff; margin-bottom:20px;">SECURE UPLINK GATEWAY</h2>
        <button class="shield-btn" onclick="launchCloak()">ESTABLISH CONNECTION</button>
        <p style="color:#666; font-size:0.8rem; margin-top:20px;">Launching in secure environment (about:blank)</p>
    </div>

    <template id="payload-template">
        <!DOCTYPE html>
        <html>
        <head>
            <title>Galactic Node</title>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Orbitron:wght@500;700&display=swap');
                
                :root { --primary: #00eaff; --secondary: #7000ff; --bg: #05070a; --glass: rgba(20, 25, 35, 0.7); --border: rgba(255, 255, 255, 0.1); }
                
                body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Inter', sans-serif; color: #eef2f5; transition: 0.5s; }
                
                body.fx-invert { filter: invert(1); } body.fx-flip { transform: rotate(180deg); }
                body.fx-shake { animation: shake 0.1s infinite; } @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -2px); } }

                #app { display: flex; width: 100vw; height: 100vh; flex-direction: column; background: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #000 100%); }
                
                .glass-panel { background: var(--glass); backdrop-filter: blur(12px); border: 1px solid var(--border); box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
                
                .header { height: 60px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: rgba(0,0,0,0.3); }
                .nav-btn { background: transparent; border: none; color: #889; padding: 10px 15px; cursor: pointer; font-family: 'Orbitron'; font-size: 0.8rem; transition: 0.3s; border-radius: 4px; }
                .nav-btn:hover { color: white; background: rgba(255,255,255,0.05); }
                .nav-btn.active { color: var(--primary); background: rgba(0, 234, 255, 0.1); box-shadow: 0 0 10px rgba(0, 234, 255, 0.2); }

                .main-body { flex: 1; display: flex; overflow: hidden; padding: 20px; gap: 20px; }
                .sidebar { width: 250px; display: flex; flex-direction: column; border-radius: 12px; padding: 15px; gap: 10px; }
                .content { flex: 1; display: flex; flex-direction: column; border-radius: 12px; overflow: hidden; position: relative; }
                
                .view-panel { display: none; flex: 1; flex-direction: column; }
                .view-panel.active { display: flex; }

                #chat-history { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
                .msg-row { display: flex; flex-direction: column; max-width: 75%; animation: pop 0.2s ease; }
                @keyframes pop { from{transform:scale(0.95); opacity:0;} to{transform:scale(1); opacity:1;} }
                .msg-row.mine { align-self: flex-end; align-items: flex-end; }
                .msg-bubble { padding: 10px 15px; border-radius: 12px; font-size: 0.9rem; line-height: 1.4; word-wrap: break-word; }
                .msg-row.mine .msg-bubble { background: linear-gradient(135deg, var(--secondary), #5000cc); color: white; border-bottom-right-radius: 2px; }
                .msg-row.theirs .msg-bubble { background: rgba(255,255,255,0.1); border-bottom-left-radius: 2px; }
                .msg-info { font-size: 0.7rem; color: #889; margin-bottom: 4px; }

                .input-area { padding: 15px; background: rgba(0,0,0,0.2); display: flex; gap: 10px; align-items: center; }
                input { flex: 1; background: rgba(0,0,0,0.4); border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px; outline: none; font-family: 'Inter'; }
                input:focus { border-color: var(--primary); }
                .send-btn { background: var(--primary); color: #000; border: none; padding: 0 20px; border-radius: 8px; font-weight: bold; cursor: pointer; height: 40px; font-family: 'Orbitron'; }

                .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
                .modal-box { background: #151a25; border: 1px solid var(--border); padding: 30px; width: 400px; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center; }
                .act-btn { width: 100%; padding: 10px; margin-top: 5px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: #ccc; cursor: pointer; border-radius: 6px; }
                .act-btn:hover { background: rgba(255,255,255,0.1); color: white; }

                .dm-sidebar { width: 200px; background: rgba(0,0,0,0.2); border-right: 1px solid var(--border); overflow-y: auto; }
                .dm-btn { padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; color: #aaa; transition: 0.2s; }
                .dm-btn:hover { background: rgba(255,255,255,0.05); color: white; }
                .dm-btn.selected { border-left: 3px solid var(--secondary); background: rgba(112, 0, 255, 0.1); color: var(--secondary); }

                .user-card { padding: 10px; background: rgba(255,255,255,0.03); border-radius: 6px; display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 5px; }
                .user-card:hover { background: rgba(255,255,255,0.08); }
                .status-dot { width: 8px; height: 8px; border-radius: 50%; }
            </style>
        </head>
        <body>
            <div id="login-modal" class="modal" style="display: flex;">
                <div class="modal-box">
                    <h2 style="font-family:'Orbitron'; color:var(--primary); margin-top:0;">SYSTEM LOGIN</h2>
                    <input id="u" placeholder="Identity" style="margin-bottom:10px; width:93%;">
                    <input id="p" type="password" placeholder="Key" style="margin-bottom:15px; width:93%;">
                    <button class="send-btn" style="width:100%;" onclick="login()">CONNECT</button>
                    <div id="login-err" style="color:#ff4444; font-size:0.8rem; margin-top:10px;"></div>
                </div>
            </div>

            <div id="user-menu" class="modal">
                <div class="modal-box">
                    <h3 id="target-name" style="color:var(--primary); font-family:'Orbitron';">USER</h3>
                    <button class="act-btn" style="border-color:var(--secondary); color:var(--secondary);" onclick="startDM()">SECURE LINK</button>
                    <div id="admin-opts" style="display:none; margin-top:10px;">
                        <button class="act-btn" style="color:orange;" onclick="adm('timeout')">TIMEOUT (30s)</button>
                        <button class="act-btn" style="color:cyan;" onclick="adm('mute')">MUTE</button>
                        <button class="act-btn" style="color:red;" onclick="adm('kick')">KICK</button>
                        <button class="act-btn" style="background:red; color:white; border:none;" onclick="adm('ban_user')">BAN IP</button>
                    </div>
                    <div id="owner-opts" style="display:none; margin-top:10px; border-top:1px solid #333; padding-top:10px;">
                        <input id="redir-url" placeholder="Redirect URL..." style="width:93%; margin-bottom:5px;">
                        <button class="act-btn" onclick="own('redirect')">REDIRECT BROWSER</button>
                        <div style="display:flex; gap:5px;">
                            <button class="act-btn" onclick="own('effect','invert')">INVERT</button>
                            <button class="act-btn" onclick="own('effect','flip')">FLIP</button>
                            <button class="act-btn" onclick="own('effect','shake')">QUAKE</button>
                        </div>
                        <button class="act-btn" style="color:var(--primary);" onclick="own('getDetails')">VIEW IP</button>
                    </div>
                    <button class="act-btn" style="margin-top:15px;" onclick="closeModal('user-menu')">CLOSE</button>
                </div>
            </div>

            <div id="owner-panel" class="modal">
                <div class="modal-box" style="width:500px;">
                    <h2 style="font-family:'Orbitron'; color:var(--primary);">OVERSEER</h2>
                    <div style="display:flex; justify-content:space-around; margin-bottom:15px; color:#aaa;">
                        <span>UPTIME: <b id="stat-up" style="color:white;">0</b>s</span>
                        <span>MSGS: <b id="stat-msg" style="color:white;">0</b></span>
                    </div>
                    <input id="announce-txt" placeholder="Announcement..." style="width:65%;">
                    <button class="act-btn" style="width:auto; display:inline-block;" onclick="announce()">BROADCAST</button>
                    <div style="margin-top:15px; text-align:left;">
                        <input id="ban-word-in" placeholder="Add Banned Word..." style="width:65%;">
                        <button class="act-btn" style="width:auto; display:inline-block;" onclick="banWord()">ADD</button>
                    </div>
                    <div style="display:flex; gap:20px; margin-top:20px; text-align:left; height:150px;">
                        <div style="flex:1;">
                            <small>BANNED IPS</small>
                            <div id="list-ips" style="overflow-y:auto; height:100px; background:rgba(0,0,0,0.3); padding:5px;"></div>
                        </div>
                        <div style="flex:1;">
                            <small>BANNED WORDS</small>
                            <div id="list-words" style="overflow-y:auto; height:100px; background:rgba(0,0,0,0.3); padding:5px;"></div>
                        </div>
                    </div>
                    <button class="act-btn" onclick="closeModal('owner-panel')">CLOSE</button>
                </div>
            </div>

            <div id="app" style="display:none;">
                <div class="header glass-panel">
                    <div>
                        <button class="nav-btn active" onclick="setChan('general')">GENERAL</button>
                        <button class="nav-btn" onclick="setChan('gaming')">GAMING</button>
                        <button class="nav-btn" onclick="setChan('memes')">MEMES</button>
                    </div>
                    <div>
                        <button class="nav-btn" onclick="setView('hub')">HUB</button>
                        <button class="nav-btn" onclick="setView('dm')">SECURE</button>
                    </div>
                </div>

                <div class="main-body">
                    <div class="sidebar glass-panel">
                        <div style="font-family:'Orbitron'; color:var(--primary); margin-bottom:10px;">AGENTS</div>
                        <div id="user-list" style="flex:1; overflow-y:auto;"></div>
                        <div onclick="openOwner()" style="cursor:pointer; padding-top:10px; border-top:1px solid var(--border); display:flex; gap:10px; align-items:center;">
                            <div style="width:30px; height:30px; background:var(--primary); border-radius:50%;"></div>
                            <div>
                                <div id="my-name" style="font-weight:bold;">...</div>
                                <div id="my-role" style="font-size:0.7rem; color:#888;">...</div>
                            </div>
                        </div>
                    </div>

                    <div class="content glass-panel">
                        <div id="view-chat" class="view-panel active">
                            <div id="chat-history"></div>
                            <div id="typing" style="height:20px; font-size:0.7rem; color:var(--primary); padding-left:20px;"></div>
                            <div class="input-area">
                                <input id="msg-in" placeholder="Transmit...">
                                <button class="send-btn" onclick="send()">SEND</button>
                            </div>
                        </div>
                        <div id="view-hub" class="view-panel" style="padding:20px;">
                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <button class="act-btn" style="width:auto;" onclick="document.getElementById('hub-f').src='https://amp.nov.su'">PROXY</button>
                                <button class="act-btn" style="width:auto;" onclick="document.getElementById('hub-f').src='https://spaceracer.onrender.com'">GAME</button>
                            </div>
                            <iframe id="hub-f" src="about:blank" style="flex:1; border:none; background:#000;" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
                        </div>
                        <div id="view-dm" class="view-panel" style="flex-direction:row;">
                            <div class="dm-sidebar">
                                <div style="padding:10px; color:var(--secondary); font-family:'Orbitron';">LINKS</div>
                                <div id="dm-list"></div>
                            </div>
                            <div style="flex:1; display:flex; flex-direction:column; background:rgba(0,0,0,0.2);">
                                <div id="dm-header" style="padding:10px; border-bottom:1px solid var(--border); display:none;">LINKED</div>
                                <div id="dm-history" style="flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:10px;"></div>
                                <div id="dm-typing" style="height:20px; font-size:0.7rem; color:var(--secondary); padding-left:20px;"></div>
                                <div id="dm-input-box" class="input-area" style="display:none;">
                                    <input id="dm-in" placeholder="Encrypted...">
                                    <button class="send-btn" style="background:var(--secondary);" onclick="sendDM()">SEND</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"><\/script>
            <script>
                const SERVER = 'http://localhost:3000'; // CHANGE THIS
                const socket = io(SERVER);
                let me = null; let curChan = 'general'; let selUser = null; let activeDMs = {}; let curDM = null; let typeTO;

                function login() {
                    const name = document.getElementById('u').value;
                    const pass = document.getElementById('p').value;
                    if(name) socket.emit('join', {name, password: pass});
                }
                document.getElementById('u').addEventListener('keyup', e => { if(e.key === 'Enter') login(); });
                document.getElementById('p').addEventListener('keyup', e => { if(e.key === 'Enter') login(); });

                socket.on('loginError', m => document.getElementById('login-err').innerText = m);
                socket.on('loginSuccess', d => {
                    me = d.user;
                    document.getElementById('login-modal').style.display='none';
                    document.getElementById('app').style.display='flex';
                    document.getElementById('my-name').innerText = me.name;
                    document.getElementById('my-role').innerText = me.role;
                });

                socket.on('message', m => { if(m.channel && m.channel !== curChan) return; renderMsg(m, 'chat-history'); });
                function renderMsg(m, divId) {
                    const d = document.createElement('div');
                    const isMe = me && m.user === me.name;
                    d.className = `msg-row ${isMe ? 'mine' : 'theirs'}`;
                    let c = '#00eaff';
                    if(m.role === 'Owner') c = '#ff3333';
                    if(m.role === 'VIP') c = '#d600ff';
                    d.innerHTML = `<div class="msg-info" style="color:${c}">${m.user} <span style="color:#666">${m.timestamp}</span></div><div class="msg-bubble" style="border-left:3px solid ${c}">${m.text}</div>`;
                    const container = document.getElementById(divId);
                    container.appendChild(d);
                    container.scrollTop = container.scrollHeight;
                }
                function send() {
                    const t = document.getElementById('msg-in').value;
                    if(t) { socket.emit('chatMessage', {text:t, channel: curChan}); document.getElementById('msg-in').value=''; }
                }
                document.getElementById('msg-in').addEventListener('input', () => {
                    socket.emit('typing', {channel: curChan});
                    clearTimeout(typeTO); typeTO = setTimeout(() => socket.emit('stopTyping', {channel: curChan}), 1000);
                });
                document.getElementById('msg-in').addEventListener('keyup', e => { if(e.key === 'Enter') send(); });
                socket.on('userTyping', d => { if(d.channel === curChan) document.getElementById('typing').innerText = `${d.user} is typing...`; });
                socket.on('userStopTyping', () => document.getElementById('typing').innerText = '');

                socket.on('userList', l => {
                    const list = document.getElementById('user-list');
                    list.innerHTML = '';
                    l.forEach(u => {
                        if(u.name === me.name) return;
                        const el = document.createElement('div');
                        el.className = 'user-card';
                        el.innerHTML = `<div class="status-dot" style="background:${u.role==='Owner'?'red':u.role==='Admin'?'orange':'#00ff00'}"></div> ${u.name}`;
                        el.onclick = () => openUserMenu(u);
                        list.appendChild(el);
                    });
                });

                function openUserMenu(u) {
                    selUser = u;
                    document.getElementById('target-name').innerText = u.name;
                    document.getElementById('user-menu').style.display='flex';
                    if(me.role === 'Admin' || me.role === 'Owner') document.getElementById('admin-opts').style.display='block';
                    if(me.role === 'Owner') document.getElementById('owner-opts').style.display='block';
                }

                function startDM() { socket.emit('dmRequest', selUser.id); closeModal('user-menu'); }
                function adm(t) { socket.emit('adminAction', {type:t, targetId: selUser.id}); closeModal('user-menu'); }
                function own(t, fx) {
                    const url = document.getElementById('redir-url').value;
                    socket.emit('ownerAction', {type:t, targetId: selUser.id, url, effect: fx});
                }
                function openOwner() {
                    if(me.role !== 'Owner') return;
                    socket.emit('ownerAction', {type:'getStats'});
                    document.getElementById('owner-panel').style.display='flex';
                }
                function announce() { socket.emit('adminAction', {type:'announce', text: document.getElementById('announce-txt').value}); }
                function banWord() { socket.emit('ownerAction', {type:'banWord', word: document.getElementById('ban-word-in').value}); }
                socket.on('ownerData', d => {
                    document.getElementById('stat-up').innerText = d.stats.uptime;
                    document.getElementById('stat-msg').innerText = d.stats.totalMsg;
                    document.getElementById('stat-users').innerText = d.stats.userCount;
                    document.getElementById('list-ips').innerHTML = d.bannedIPs.map(ip => `<div>${ip} <b onclick="unban('${ip}')" style="color:red;cursor:pointer;">X</b></div>`).join('');
                    document.getElementById('list-words').innerHTML = d.bannedWords.join(', ');
                });
                function unban(ip) { socket.emit('ownerAction', {type:'unbanIP', ip}); }
                socket.on('userDetails', u => alert(`IP: ${u.ip}\nID: ${u.id}\nStatus: ${u.status}`));

                socket.on('incomingDMRequest', d => { if(confirm(`${d.name} wants to link.`)) socket.emit('dmAccepted', d.fromId); });
                socket.on('dmStart', d => { if(!activeDMs[d.withId]) activeDMs[d.withId] = {name: d.name, msgs: []}; openDM(d.withId); });
                function openDM(id) {
                    curDM = id;
                    const h = document.getElementById('dm-history');
                    h.innerHTML = '';
                    activeDMs[id].msgs.forEach(m => renderDmMsg(m));
                    document.getElementById('dm-header').style.display='block';
                    document.getElementById('dm-header').innerText = `LINKED: ${activeDMs[id].name}`;
                    document.getElementById('dm-input-box').style.display='flex';
                    setView('dm');
                    renderDmList();
                }
                function renderDmList() {
                    const l = document.getElementById('dm-list');
                    l.innerHTML = '';
                    Object.keys(activeDMs).forEach(k => {
                        const el = document.createElement('div');
                        el.className = `dm-btn ${k===curDM?'selected':''}`;
                        el.innerText = activeDMs[k].name;
                        el.onclick = () => openDM(k);
                        l.appendChild(el);
                    });
                }
                socket.on('privateMsgReceive', m => {
                    const pid = m.fromId === socket.id ? curDM : m.fromId;
                    if(!activeDMs[pid] && m.fromId !== socket.id) activeDMs[m.fromId] = {name: m.name, msgs: []};
                    const target = activeDMs[pid];
                    if(target) { target.msgs.push(m); if(curDM === pid) renderDmMsg(m); }
                });
                function renderDmMsg(m) {
                    const d = document.createElement('div');
                    const isMe = m.fromId === socket.id;
                    d.className = `msg-row ${isMe ? 'mine' : 'theirs'}`;
                    d.innerHTML = `<div class="msg-bubble" style="background:${isMe?'#7000ff':'#222'}">${m.text}</div>`;
                    document.getElementById('dm-history').appendChild(d);
                }
                function sendDM() {
                    const t = document.getElementById('dm-in').value;
                    if(t && curDM) { socket.emit('privateMessage', {to: curDM, text: t}); document.getElementById('dm-in').value=''; }
                }
                document.getElementById('dm-in').addEventListener('input', () => {
                    if(curDM) socket.emit('typing', {targetId: curDM});
                    clearTimeout(typeTO); typeTO = setTimeout(() => socket.emit('stopTyping', {targetId: curDM}), 1000);
                });
                document.getElementById('dm-in').addEventListener('keyup', e => { if(e.key === 'Enter') sendDM(); });
                socket.on('dmTyping', d => { if(curDM === d.fromId) document.getElementById('dm-typing').innerText = 'User is typing...'; });
                socket.on('dmStopTyping', d => { if(curDM === d.fromId) document.getElementById('dm-typing').innerText = ''; });

                function setView(v) { document.querySelectorAll('.view-panel').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+v).classList.add('active'); }
                function setChan(c) { curChan = c; document.getElementById('chat-history').innerHTML=''; socket.emit('switchChannel', c); setView('chat'); }
                function closeModal(id) { document.getElementById(id).style.display='none'; }
                socket.on('sysErr', m => alert(m));
                socket.on('banAlert', m => document.body.innerHTML = `<h1 style="color:red;text-align:center;margin-top:20%;">${m}</h1>`);
                socket.on('forceRedirect', u => window.location.href = u);
                socket.on('applyEffect', fx => document.body.classList.toggle('fx-'+fx));
                socket.on('announcement', m => alert(`BROADCAST FROM ${m.sender}:\n\n${m.text}`));
            <\/script>
        </body>
        </html>
    </template>

    <script>
        function launchCloak() {
            const win = window.open('about:blank', '_blank');
            if(!win) { alert("Popup blocked. Please allow popups."); return; }
            const payload = document.getElementById('payload-template').innerHTML;
            win.document.write(payload);
            win.document.close();
            window.location.replace("https://myapps.classlink.com/home");
        }
    </script>
</body>
</html>
