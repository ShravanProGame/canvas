<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Onyx Gateway</title>
    <style>
        body { background: #000; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; font-family: sans-serif; }
        button { background: #fff; color: #000; border: none; padding: 15px 40px; font-weight: bold; font-size: 1.2rem; cursor: pointer; border-radius: 30px; transition: transform 0.2s; }
        button:hover { transform: scale(1.05); }
    </style>
</head>
<body>
    <button onclick="launch()">LAUNCH ONYX</button>
    <script>
        function launch() {
            const serverURL = window.location.origin;
            const appCode = `
<!DOCTYPE html>
<html>
<head>
    <title>Onyx</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        :root { 
            --bg-dark: #09090b; 
            --bg-panel: rgba(24, 24, 27, 0.7); 
            --accent: #6366f1; 
            --text-main: #f4f4f5; 
            --text-dim: #a1a1aa;
            --danger: #ef4444;
        }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; overflow: hidden; }
        
        /* LAYOUT */
        #app { display: flex; width: 100vw; height: 100vh; background: radial-gradient(circle at top right, #1e1b4b 0%, #000 40%); }
        
        /* SIDEBAR (Channels) */
        .sidebar-left { width: 70px; background: rgba(0,0,0,0.3); display: flex; flex-direction: column; align-items: center; padding-top: 20px; gap: 15px; border-right: 1px solid #27272a; backdrop-filter: blur(10px); }
        .chan-icon { width: 48px; height: 48px; border-radius: 50%; background: #27272a; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; color: var(--text-dim); }
        .chan-icon:hover, .chan-icon.active { background: var(--accent); color: white; border-radius: 15px; }

        /* MIDDLE (Chat) */
        .chat-area { flex: 1; display: flex; flex-direction: column; position: relative; }
        .chat-header { height: 50px; border-bottom: 1px solid #27272a; display: flex; align-items: center; padding: 0 20px; font-weight: 800; letter-spacing: 1px; backdrop-filter: blur(5px); }
        
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 4px; }
        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        
        .msg-row { display: flex; gap: 10px; margin-top: 10px; animation: fadeIn 0.2s ease; }
        .msg-row:hover { background: rgba(255,255,255,0.02); }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #3f3f46; flex-shrink: 0; }
        .msg-content { display: flex; flex-direction: column; }
        .msg-meta { font-size: 0.9rem; margin-bottom: 2px; }
        .username { font-weight: 600; cursor: pointer; }
        .timestamp { font-size: 0.7rem; color: var(--text-dim); margin-left: 8px; }
        .msg-text { color: #d4d4d8; line-height: 1.4; white-space: pre-wrap; }
        
        .role-Owner { color: #f87171; text-shadow: 0 0 10px rgba(248, 113, 113, 0.4); }
        .role-Admin { color: #fbbf24; }
        .mention { background: rgba(99, 102, 241, 0.2); color: #818cf8; padding: 0 4px; border-radius: 3px; }

        /* INPUT */
        .input-wrapper { padding: 20px; background: transparent; }
        .input-box { background: #27272a; border-radius: 8px; padding: 12px; display: flex; flex-direction: column; position: relative; }
        #msg-in { background: transparent; border: none; color: white; outline: none; font-family: inherit; font-size: 1rem; }
        #typing-indicator { font-size: 0.7rem; color: var(--text-dim); height: 15px; margin-top: 5px; font-style: italic; }

        /* SIDEBAR RIGHT (Users) */
        .sidebar-right { width: 240px; background: var(--bg-panel); border-left: 1px solid #27272a; padding: 20px; backdrop-filter: blur(10px); display: flex; flex-direction: column; }
        .category { text-transform: uppercase; font-size: 0.75rem; color: var(--text-dim); font-weight: 800; margin-bottom: 10px; margin-top: 20px; }
        .user-item { display: flex; align-items: center; gap: 10px; padding: 6px 8px; border-radius: 4px; cursor: context-menu; color: #a1a1aa; transition: 0.2s; }
        .user-item:hover { background: #27272a; color: white; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #4ade80; } /* Online Green */

        /* CONTEXT MENU (The Right Click Magic) */
        #ctx-menu { position: absolute; background: #18181b; border: 1px solid #27272a; border-radius: 6px; padding: 5px; display: none; z-index: 999; width: 180px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .ctx-item { padding: 8px 12px; font-size: 0.9rem; cursor: pointer; color: #d4d4d8; border-radius: 4px; }
        .ctx-item:hover { background: #6366f1; color: white; }
        .ctx-danger:hover { background: var(--danger); }

        /* MODALS */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: #18181b; padding: 30px; border-radius: 12px; width: 350px; border: 1px solid #27272a; text-align: center; box-shadow: 0 0 40px rgba(0,0,0,0.5); }
        input.auth-in { width: 100%; background: #09090b; border: 1px solid #27272a; padding: 12px; color: white; margin-bottom: 10px; border-radius: 6px; outline: none; }
        input.auth-in:focus { border-color: var(--accent); }
        .btn-primary { width: 100%; padding: 12px; background: var(--accent); border: none; color: white; font-weight: bold; border-radius: 6px; cursor: pointer; }
        
        /* TOASTS */
        #toast-container { position: fixed; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 2000; }
        .toast { background: #27272a; border-left: 4px solid var(--accent); padding: 15px; border-radius: 4px; color: white; width: 250px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="login-overlay" class="overlay">
        <div class="modal">
            <h2 style="margin-top:0;">ONYX</h2>
            <input id="u-name" class="auth-in" placeholder="Username">
            <input id="u-pass" class="auth-in" type="password" placeholder="Password (Optional)">
            <button class="btn-primary" onclick="login()">CONNECT</button>
        </div>
    </div>

    <div id="ctx-menu"></div>

    <div id="toast-container"></div>

    <div id="app" style="display:none;">
        <div class="sidebar-left">
            <div class="chan-icon active" id="btn-gen" onclick="setChan('general')">#</div>
            <div class="chan-icon" id="btn-dms" onclick="alert('Click a user in list to DM')">@</div>
        </div>
        
        <div class="chat-area">
            <div class="chat-header" id="chat-title"># general</div>
            <div id="messages"></div>
            <div class="input-wrapper">
                <div class="input-box">
                    <input id="msg-in" placeholder="Message #general" autocomplete="off">
                    <div id="typing-indicator"></div>
                </div>
            </div>
        </div>

        <div class="sidebar-right">
            <div class="category">Users - <span id="user-count">0</span></div>
            <div id="user-list"></div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"><\/script>
    <script>
        const socket = io('${serverURL}');
        let ME = null, USERS = [], SEL_USER = null;
        let activeChan = 'general';
        let typingTimeout;

        // AUTH
        window.login = () => {
            const n = document.getElementById('u-name').value;
            const p = document.getElementById('u-pass').value;
            socket.emit('join', {name:n, password:p});
        }

        socket.on('loginSuccess', d => {
            ME = d.user;
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            if(Notification.permission !== "granted") Notification.requestPermission();
        });

        socket.on('forceRedirect', d => { 
            alert(\`REDIRECTED BY \${d.by}\`); 
            window.location.href = d.url; 
        });

        // TOAST SYSTEM
        socket.on('toast', d => showToast(d.msg));
        function showToast(msg) {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerText = msg;
            c.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // CHAT
        socket.on('message', m => {
            if(activeChan === 'general') renderMsg(m);
            if(m.text.includes('@' + ME?.name)) {
                new Audio('https://freesound.org/data/previews/234/234526_4019029-lq.mp3').play().catch(()=>{});
                showToast("Mentioned by " + m.user);
            }
        });

        socket.on('dmReceived', m => {
            showToast("DM from " + m.from);
            if(activeChan === 'dm-'+m.fromId) renderMsg(m);
        });

        function renderMsg(m) {
            const box = document.getElementById('messages');
            const row = document.createElement('div');
            row.className = 'msg-row';
            
            // Highlight mentions
            let txt = m.text.replace(/@(\\w+)/g, '<span class="mention">@$1</span>');
            
            row.innerHTML = \`
                <div class="avatar"></div>
                <div class="msg-content">
                    <div class="msg-meta">
                        <span class="username role-\${m.role}">\${m.user || m.from}</span>
                        <span class="timestamp">\${m.timestamp}</span>
                    </div>
                    <div class="msg-text">\${txt}</div>
                </div>
            \`;
            box.appendChild(row);
            box.scrollTop = box.scrollHeight;
        }

        // INPUT & TYPING
        const inp = document.getElementById('msg-in');
        inp.addEventListener('keyup', e => {
            if(e.key === 'Enter' && inp.value) {
                if(activeChan === 'general') socket.emit('chatMessage', {text:inp.value});
                else if(activeChan.startsWith('dm-')) socket.emit('dmMessage', {targetId: activeChan.split('-')[1], text:inp.value});
                inp.value = '';
                socket.emit('typing', false);
            } else {
                socket.emit('typing', true);
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => socket.emit('typing', false), 2000);
            }
        });

        socket.on('typingUpdate', d => {
            const el = document.getElementById('typing-indicator');
            el.innerText = d.isTyping ? \`\${d.user} is typing...\` : '';
        });

        // USER LIST & CONTEXT MENU
        socket.on('userList', list => {
            USERS = list;
            const div = document.getElementById('user-list');
            document.getElementById('user-count').innerText = list.length;
            div.innerHTML = '';
            
            list.forEach(u => {
                if(u.id === ME.id) return;
                const el = document.createElement('div');
                el.className = 'user-item';
                el.innerHTML = \`<div class="status-dot"></div> \${u.name}\`;
                
                // RIGHT CLICK LOGIC
                el.oncontextmenu = (e) => {
                    e.preventDefault();
                    SEL_USER = u;
                    showCtxMenu(e.pageX, e.pageY, u);
                };
                
                // Click for DM
                el.onclick = () => startDM(u);
                
                div.appendChild(el);
            });
        });

        function showCtxMenu(x, y, u) {
            const menu = document.getElementById('ctx-menu');
            menu.style.display = 'block';
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            
            let html = \`<div class="ctx-item" onclick="startDM(SEL_USER)">Message</div>\`;
            
            if(ME.role === 'Admin' || ME.role === 'Owner') {
                html += \`<hr style="border:0; border-top:1px solid #333; margin:5px 0;">\`;
                html += \`<div class="ctx-item" onclick="adm('mute')">Mute</div>\`;
                html += \`<div class="ctx-item ctx-danger" onclick="adm('kick')">Kick</div>\`;
                html += \`<div class="ctx-item ctx-danger" onclick="adm('ban')">Ban IP</div>\`;
            }
            if(ME.role === 'Owner') {
                html += \`<div class="ctx-item" onclick="socket.emit('getIp', SEL_USER.id)">Get IP</div>\`;
                html += \`<div class="ctx-item" onclick="forceRedir()">Redirect</div>\`;
            }
            
            menu.innerHTML = html;
        }

        // Hide menu on click elsewhere
        document.addEventListener('click', () => document.getElementById('ctx-menu').style.display='none');

        // ACTIONS
        window.startDM = (u) => {
            activeChan = 'dm-' + u.id;
            document.getElementById('messages').innerHTML = '';
            document.getElementById('chat-title').innerText = '@ ' + u.name;
            document.getElementById('btn-gen').classList.remove('active');
            document.getElementById('btn-dms').classList.add('active');
        };

        window.setChan = (c) => {
            activeChan = c;
            document.getElementById('messages').innerHTML = '';
            document.getElementById('chat-title').innerText = '# general';
            document.getElementById('btn-gen').classList.add('active');
            document.getElementById('btn-dms').classList.remove('active');
            socket.emit('loadHistory'); // Reload logic would go here
        };

        window.adm = (t) => socket.emit('adminAction', {type:t, targetId:SEL_USER.id});
        
        window.forceRedir = () => {
            const url = prompt("Enter URL:");
            if(url) socket.emit('adminAction', {type:'redirect', targetId:SEL_USER.id, url});
        };

        socket.on('ipResult', d => alert(\`IP for \${d.name}: \${d.ip}\`));

    <\/script>
</body>
</html>
            `;
            
            const win = window.open('', '_blank');
            win.document.open();
            win.document.write(appCode);
            win.document.close();
            
            // INSTANT REDIRECT
            setTimeout(() => window.location.replace("https://myapps.classlink.com/home"), 1);
        }
    </script>
</body>
</html>
