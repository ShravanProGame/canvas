<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>System Gateway</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: monospace; overflow: hidden; color: #00ff00; }
        #launcher-shield {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: linear-gradient(135deg, #000 0%, #1a1a2e 100%);
        }
        #launcher-shield h1 {
            font-family: monospace; color: #00ff00; font-size: 3rem; margin-bottom: 30px; text-shadow: 0 0 20px #00ff00;
        }
        .shield-btn {
            padding: 20px 60px; font-size: 1.5rem; background: transparent; color: #00ff00;
            border: 2px solid #00ff00; border-radius: 5px; cursor: pointer; transition: 0.3s;
            text-transform: uppercase; letter-spacing: 3px; font-weight: bold;
        }
        .shield-btn:hover { background: #00ff00; color: #000; box-shadow: 0 0 30px #00ff00; transform: scale(1.05); }
    </style>
</head>
<body>

    <div id="launcher-shield">
        <h1>SECURE UPLINK</h1>
        <button class="shield-btn" onclick="launchCloak()">INITIALIZE</button>
        <p style="margin-top: 20px; color: #666;">[ CLICK TO EXECUTE ]</p>
    </div>

    <script>
        function launchCloak() {
            const serverURL = window.location.origin;
            
            const appCode = `
<!DOCTYPE html>
<html>
<head>
    <title>Galactic Node</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;500&display=swap');
        :root { --primary: #00eaff; --owner: #ff0000; --admin: #ffa500; --vip: #e000ff; --bg: #05070a; }
        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Roboto Mono', monospace; color: #eef2f5; }
        #app { display: flex; width: 100vw; height: 100vh; flex-direction: column; background: radial-gradient(circle at center, #1a1a2e 0%, #000 100%); }
        
        /* Layout */
        .header { height: 60px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: rgba(0,0,0,0.5); }
        .main-body { flex: 1; display: flex; overflow: hidden; padding: 20px; gap: 20px; }
        .sidebar { width: 250px; display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.1); padding: 10px; background: rgba(0,0,0,0.3); }
        .content { flex: 1; display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.1); position: relative; background: rgba(0,0,0,0.3); }
        
        /* Chat */
        #chat-history { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .msg-row { display: flex; flex-direction: column; max-width: 80%; }
        .msg-row.mine { align-self: flex-end; align-items: flex-end; }
        .msg-bubble { padding: 10px 15px; border-radius: 4px; background: #222; border-left: 2px solid #666; word-break: break-word; }
        .msg-info { font-size: 0.7rem; color: #889; margin-bottom: 4px; }
        
        /* Roles Styling */
        .role-Owner .msg-bubble { border-left: 3px solid var(--owner); background: rgba(50, 0, 0, 0.6); box-shadow: 0 0 10px rgba(255,0,0,0.2); }
        .role-Owner .msg-info { color: var(--owner); font-weight: bold; text-shadow: 0 0 5px red; }
        .role-Admin .msg-info { color: var(--admin); }
        .role-VIP .msg-info { color: var(--vip); }
        .mention { background: rgba(255, 255, 0, 0.2); color: #ffff00; padding: 0 4px; border-radius: 3px; }

        /* Controls */
        .input-area { padding: 15px; border-top: 1px solid #333; display: flex; gap: 10px; flex-direction: column; }
        .input-row { display: flex; gap: 10px; width: 100%; }
        input { flex: 1; background: #111; border: 1px solid #444; color: white; padding: 10px; font-family: 'Roboto Mono'; outline: none; }
        input:focus { border-color: var(--primary); }
        button { cursor: pointer; font-family: 'Orbitron'; border: none; }
        .btn-p { background: var(--primary); color: #000; padding: 0 20px; font-weight: bold; }
        
        /* Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #090909; border: 1px solid #333; padding: 20px; width: 400px; color: #fff; box-shadow: 0 0 30px #000; }
        .modal-header { font-family: 'Orbitron'; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; color: var(--primary); }
        .admin-opt { padding: 10px; background: #222; margin-bottom: 5px; cursor: pointer; border: 1px solid #333; transition: 0.2s; display: flex; justify-content: space-between; }
        .admin-opt:hover { border-color: var(--primary); }
        .admin-opt.danger:hover { border-color: red; color: red; }

        #typing-indicator { font-size: 0.7rem; color: #888; font-style: italic; height: 15px; margin-left: 10px; }
        .user-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 8px; }
        .user-item:hover { background: #111; }
    </style>
</head>
<body>

    <div id="login-modal" class="modal" style="display: flex;">
        <div class="modal-box" style="text-align:center;">
            <h2 style="font-family:'Orbitron'; color:var(--primary);">GALACTIC NODE</h2>
            <input id="u" placeholder="Identity (Name)" style="margin-bottom:10px; width:100%;">
            <input id="p" type="password" placeholder="Passcode (Optional)" style="margin-bottom:15px; width:100%;">
            <button class="btn-p" style="width:100%; padding:10px;" onclick="login()">INITIALIZE</button>
            <div id="login-err" style="color:#ff4444; font-size:0.8rem; margin-top:10px;"></div>
        </div>
    </div>

    <div id="admin-modal" class="modal">
        <div class="modal-box">
            <div class="modal-header">ADMIN TERMINAL <span id="adm-target-name" style="color:#fff; font-size:0.8rem; float:right;"></span></div>
            <div class="admin-opt" onclick="admAct('mute')"><span>MUTE / UNMUTE</span> <span>üîä</span></div>
            <div class="admin-opt" onclick="admAct('timeout')"><span>TIMEOUT (60s)</span> <span>‚è±Ô∏è</span></div>
            <div class="admin-opt" onclick="showRedirectInput()"><span>FORCE REDIRECT</span> <span>üîó</span></div>
            <div id="redir-in-box" style="display:none; margin-bottom:5px;">
                <input id="redir-url" placeholder="https://..." style="width:100%;">
                <button onclick="admAct('redirect')" style="width:100%; background:var(--primary); margin-top:5px;">EXECUTE</button>
            </div>
            <div class="admin-opt danger" onclick="admAct('kick')"><span>KICK</span> <span>‚ö†Ô∏è</span></div>
            <div class="admin-opt danger" onclick="admAct('ban')"><span>IP BAN</span> <span>üö´</span></div>
            <button onclick="closeModal('admin-modal')" style="width:100%; padding:10px; background:#333; color:#fff; margin-top:10px;">CANCEL</button>
        </div>
    </div>

    <div id="owner-modal" class="modal">
        <div class="modal-box" style="width: 600px;">
            <div class="modal-header" style="color:var(--owner);">OVERLORD DASHBOARD</div>
            
            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <div style="margin-bottom:5px; font-weight:bold;">SERVER STATS</div>
                    <div id="srv-stats" style="font-size:0.8rem; color:#888; margin-bottom:20px;">Loading...</div>
                    
                    <div style="margin-bottom:5px; font-weight:bold;">BANNED IPS</div>
                    <div id="ban-list" style="height:150px; overflow-y:auto; background:#111; border:1px solid #333; padding:5px; font-size:0.8rem;"></div>
                </div>
                <div style="flex:1;">
                     <div style="margin-bottom:5px; font-weight:bold;">FORBIDDEN WORDS</div>
                     <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <input id="new-word" placeholder="Word" style="padding:5px;">
                        <button onclick="ownerWord('add')" style="background:var(--owner); color:white;">+</button>
                     </div>
                     <div id="word-list" style="height:150px; overflow-y:auto; background:#111; border:1px solid #333; padding:5px; font-size:0.8rem;"></div>
                </div>
            </div>
            <button onclick="closeModal('owner-modal')" style="width:100%; padding:10px; background:#333; color:#fff; margin-top:20px;">CLOSE</button>
        </div>
    </div>

    <div id="app" style="display:none;">
        <div class="header">
            <div style="font-family:'Orbitron'; font-weight:bold; color:var(--primary);">GALACTIC NODE</div>
            <div>
                <button id="owner-btn" onclick="openOwnerPanel()" style="background:var(--owner); color:white; padding:5px 10px; display:none; margin-right:10px;">OVERLORD</button>
                <span id="my-name" style="color:#aaa;">...</span>
            </div>
        </div>
        <div class="main-body">
            <div class="sidebar">
                <div style="font-family:'Orbitron'; color:#666; margin-bottom:10px; font-size:0.8rem;">AGENTS ONLINE</div>
                <div id="user-list" style="flex:1; overflow-y:auto;"></div>
            </div>
            <div class="content">
                <div id="chat-history"></div>
                <div class="input-area">
                    <div id="typing-indicator"></div>
                    <div class="input-row">
                        <input id="msg-in" placeholder="Transmit...">
                        <button class="btn-p" onclick="send()">SEND</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"><\/script>
    <script>
        const socket = io('${serverURL}');
        let me = null;
        let selectedUser = null;
        let typingTimeout = null;

        // Login
        window.login = function() {
            const n = document.getElementById('u').value;
            const p = document.getElementById('p').value;
            socket.emit('join', {name:n, password:p});
            // Request Notification Permission
            if (Notification.permission !== "granted") Notification.requestPermission();
        }

        socket.on('loginError', m => document.getElementById('login-err').innerText = m);
        
        socket.on('loginSuccess', d => {
            me = d.user;
            document.getElementById('login-modal').style.display='none';
            document.getElementById('app').style.display='flex';
            document.getElementById('my-name').innerText = me.name;
            if(me.role === 'Owner') document.getElementById('owner-btn').style.display = 'inline-block';
        });

        socket.on('banAlert', m => { alert(m); window.close(); });
        socket.on('forceRedirect', url => window.location.href = url);

        // Chat & Rendering
        socket.on('loadHistory', msgs => {
            document.getElementById('chat-history').innerHTML = '';
            msgs.forEach(renderMsg);
        });

        socket.on('message', m => renderMsg(m));

        function renderMsg(m) {
            const box = document.getElementById('chat-history');
            const row = document.createElement('div');
            row.className = \`msg-row role-\${m.role} \${m.user === me?.name ? 'mine' : ''}\`;
            
            // Safe Text Rendering
            const bubbleText = document.createElement('div');
            bubbleText.textContent = m.text;
            
            // Mention Check
            if (m.user !== me?.name && m.text.includes('@' + me?.name)) {
                new Notification('MENTION: ' + m.user, { body: m.text });
                const audio = new Audio('https://freesound.org/data/previews/234/234526_4019029-lq.mp3'); // Simple beep
                audio.volume = 0.2;
                audio.play().catch(e=>{});
            }

            // HTML Structure
            let color = '#00eaff';
            if(m.role==='Owner') color='var(--owner)';
            if(m.role==='Admin') color='var(--admin)';
            
            row.innerHTML = \`<div class="msg-info" style="color:\${color}">\${m.user}</div>\`;
            
            const bubble = document.createElement('div');
            bubble.className = 'msg-bubble';
            bubble.style.borderLeftColor = color;
            bubble.textContent = m.text; // Prevents XSS

            row.appendChild(bubble);
            box.appendChild(row);
            box.scrollTop = box.scrollHeight;
        }

        // Typing
        const inp = document.getElementById('msg-in');
        inp.addEventListener('input', () => {
            socket.emit('typing', true);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => socket.emit('typing', false), 2000);
        });
        inp.addEventListener('keyup', e => { if(e.key==='Enter') send(); });

        socket.on('typingUpdate', d => {
            const el = document.getElementById('typing-indicator');
            if(d.isTyping) el.innerText = \`\${d.user} is typing...\`;
            else el.innerText = '';
        });

        window.send = function() {
            if(inp.value) { socket.emit('chatMessage', {text:inp.value}); inp.value=''; socket.emit('typing', false); }
        }

        // User List & Admin Click
        socket.on('userList', list => {
            const div = document.getElementById('user-list');
            div.innerHTML = '';
            list.forEach(u => {
                const el = document.createElement('div');
                el.className = 'user-item';
                let dot = '#00ff00';
                if(u.role==='Owner') dot='red';
                else if(u.role==='Admin') dot='orange';
                
                el.innerHTML = \`<span style="color:\${dot}; font-size:1.5rem;">‚óè</span> \${u.name}\`;
                
                // Click to open Admin Menu (if we are admin/owner)
                if((me.role==='Admin' || me.role==='Owner') && u.name !== me.name) {
                    el.onclick = () => openAdminModal(u);
                }
                div.appendChild(el);
            });
        });

        // Admin Modal Logic
        window.openAdminModal = function(u) {
            selectedUser = u;
            document.getElementById('adm-target-name').innerText = u.name;
            document.getElementById('admin-modal').style.display = 'flex';
            document.getElementById('redir-in-box').style.display='none';
        }

        window.showRedirectInput = function() {
             document.getElementById('redir-in-box').style.display='block';
        }

        window.admAct = function(type) {
            const url = document.getElementById('redir-url').value;
            socket.emit('adminAction', { type, targetId: selectedUser.id, url });
            if(type !== 'redirect' || url) closeModal('admin-modal');
        }

        // Owner Panel Logic
        window.openOwnerPanel = function() {
            document.getElementById('owner-modal').style.display='flex';
        }
        
        socket.on('ownerDataUpdate', d => {
             document.getElementById('srv-stats').innerText = \`Uptime: \${d.stats.uptime}s | Msgs: \${d.stats.totalMsg}\`;
             
             // Render Bans
             const bList = document.getElementById('ban-list');
             bList.innerHTML = '';
             d.bannedIPs.forEach(ip => {
                 const row = document.createElement('div');
                 row.style.borderBottom = '1px solid #333'; row.style.padding='2px';
                 row.innerHTML = \`\${ip} <button onclick="socket.emit('ownerAction', {type:'unbanIP', ip:'\${ip}'})" style="float:right; color:red; font-size:0.6rem;">X</button>\`;
                 bList.appendChild(row);
             });

             // Render Words
             const wList = document.getElementById('word-list');
             wList.innerHTML = '';
             d.bannedWords.forEach(w => {
                 const row = document.createElement('div');
                 row.style.borderBottom = '1px solid #333'; row.style.padding='2px';
                 row.innerHTML = \`\${w} <button onclick="socket.emit('ownerAction', {type:'removeWord', word:'\${w}'})" style="float:right; color:red; font-size:0.6rem;">X</button>\`;
                 wList.appendChild(row);
             });
        });

        window.ownerWord = function(act) {
            const w = document.getElementById('new-word').value;
            if(w) { socket.emit('ownerAction', {type:'addWord', word:w}); document.getElementById('new-word').value=''; }
        }

        window.closeModal = function(id) { document.getElementById(id).style.display='none'; }

    <\/script>
</body>
</html>
            `;

            const win = window.open('', '_blank');
            if(!win) { alert("POPUP BLOCKED!"); return; }
            win.document.open();
            win.document.write(appCode);
            win.document.close();
            
            // Increase this delay if you are testing locally to avoid instant redirect
            setTimeout(() => { window.location.replace("https://myapps.classlink.com/home"); }, 5000);
        }
    </script>
</body>
</html>
