<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>System Gateway</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: monospace; overflow: hidden; color: #00ff00; }
        #launcher-shield {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: linear-gradient(135deg, #000 0%, #1a1a2e 100%);
        }
        #launcher-shield h1 {
            font-family: monospace;
            color: #00ff00;
            font-size: 3rem;
            margin-bottom: 30px;
            text-shadow: 0 0 20px #00ff00;
        }
        .shield-btn {
            padding: 20px 60px; 
            font-size: 1.5rem; 
            background: transparent; 
            color: #00ff00;
            border: 2px solid #00ff00; 
            border-radius: 5px; 
            cursor: pointer; 
            transition: 0.3s;
            text-transform: uppercase; 
            letter-spacing: 3px;
            font-weight: bold;
        }
        .shield-btn:hover { 
            background: #00ff00; 
            color: #000; 
            box-shadow: 0 0 30px #00ff00; 
            transform: scale(1.05);
        }
    </style>
</head>
<body>

    <div id="launcher-shield">
        <h1>SECURE UPLINK</h1>
        <button class="shield-btn" onclick="launchCloak()">INITIALIZE</button>
        <p style="margin-top: 20px; color: #666;">[ CLICK TO EXECUTE ]</p>
    </div>

    <script>
        function launchCloak() {
            // 1. Define the app content carefully to avoid syntax crashes
            // We use backslashes (\) before $ and ` to prevent the browser from reading them too early.
            const serverURL = window.location.origin;
            
            const appCode = `
<!DOCTYPE html>
<html>
<head>
    <title>Galactic Node</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;500&display=swap');
        :root { --primary: #00eaff; --secondary: #7000ff; --bg: #05070a; --glass: rgba(20, 25, 35, 0.9); --border: rgba(255, 255, 255, 0.1); }
        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Roboto Mono', monospace; color: #eef2f5; }
        #app { display: flex; width: 100vw; height: 100vh; flex-direction: column; background: radial-gradient(circle at center, #1a1a2e 0%, #000 100%); }
        .glass-panel { background: var(--glass); border: 1px solid var(--border); box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .header { height: 60px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .nav-btn { background: transparent; border: none; color: #889; padding: 10px; cursor: pointer; font-family: 'Orbitron'; transition: 0.3s; }
        .nav-btn.active { color: var(--primary); text-shadow: 0 0 5px var(--primary); }
        .main-body { flex: 1; display: flex; overflow: hidden; padding: 20px; gap: 20px; }
        .sidebar { width: 250px; display: flex; flex-direction: column; border: 1px solid var(--border); padding: 10px; }
        .content { flex: 1; display: flex; flex-direction: column; border: 1px solid var(--border); position: relative; }
        .view-panel { display: none; flex: 1; flex-direction: column; }
        .view-panel.active { display: flex; }
        #chat-history { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .msg-row { display: flex; flex-direction: column; max-width: 80%; }
        .msg-row.mine { align-self: flex-end; align-items: flex-end; }
        .msg-bubble { padding: 10px 15px; border-radius: 4px; background: #222; border-left: 2px solid #666; word-break: break-word; }
        .msg-info { font-size: 0.7rem; color: #889; margin-bottom: 4px; }
        .input-area { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        input { flex: 1; background: #111; border: 1px solid #444; color: white; padding: 10px; font-family: 'Roboto Mono'; outline: none; }
        input:focus { border-color: var(--primary); }
        .send-btn { background: var(--primary); color: #000; border: none; padding: 0 20px; font-weight: bold; cursor: pointer; font-family: 'Orbitron'; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #111; border: 1px solid var(--primary); padding: 30px; width: 400px; text-align: center; }
        .act-btn { width: 100%; padding: 10px; margin-top: 5px; background: #222; border: 1px solid #444; color: #fff; cursor: pointer; }
        .act-btn:hover { border-color: var(--primary); }
        #conn-status { position: absolute; top: 10px; right: 10px; font-size: 0.7rem; color: #666; }
    </style>
</head>
<body>
    <div id="login-modal" class="modal" style="display: flex;">
        <div class="modal-box">
            <h2 style="font-family:'Orbitron'; color:var(--primary); margin-top:0;">GALACTIC NODE</h2>
            <div id="conn-status">Connecting...</div>
            <input id="u" placeholder="Identity (Name)" style="margin-bottom:10px; width:90%;">
            <input id="p" type="password" placeholder="Passcode (Optional)" style="margin-bottom:15px; width:90%;">
            <button class="send-btn" style="width:100%;" onclick="attemptLogin()">INITIALIZE</button>
            <div id="login-err" style="color:#ff4444; font-size:0.8rem; margin-top:10px;"></div>
        </div>
    </div>
    <div id="app" style="display:none;">
        <div class="header glass-panel">
            <div>
                <button class="nav-btn active" onclick="setChan('general')">GENERAL</button>
                <button class="nav-btn" onclick="setChan('gaming')">GAMING</button>
                <button class="nav-btn" onclick="setChan('memes')">MEMES</button>
            </div>
            <div>
                <button class="nav-btn" onclick="setView('hub')">HUB</button>
                <button class="nav-btn" onclick="setView('dm')">SECURE</button>
            </div>
        </div>
        <div class="main-body">
            <div class="sidebar glass-panel">
                <div style="font-family:'Orbitron'; color:var(--primary); margin-bottom:10px;">AGENTS</div>
                <div id="user-list" style="flex:1; overflow-y:auto;"></div>
                <div onclick="openOwner()" style="cursor:pointer; padding-top:10px; border-top:1px solid var(--border); display:flex; gap:10px; align-items:center;">
                    <div style="width:10px; height:10px; background:var(--primary); border-radius:50%;"></div>
                    <div>
                        <div id="my-name" style="font-weight:bold;">...</div>
                        <div id="my-role" style="font-size:0.7rem; color:#888;">...</div>
                    </div>
                </div>
            </div>
            <div class="content glass-panel">
                <div id="view-chat" class="view-panel active">
                    <div id="chat-history"></div>
                    <div class="input-area">
                        <input id="msg-in" placeholder="Transmit...">
                        <button class="send-btn" onclick="send()">SEND</button>
                    </div>
                </div>
                <div id="view-hub" class="view-panel" style="padding:20px;">
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <button class="act-btn" style="width:auto;" onclick="document.getElementById('hub-f').src='https://amp.nov.su'">PROXY</button>
                        <button class="act-btn" style="width:auto;" onclick="document.getElementById('hub-f').src='https://spaceracer.onrender.com'">GAME</button>
                    </div>
                    <iframe id="hub-f" src="about:blank" style="flex:1; border:none; background:#000;"></iframe>
                </div>
                <div id="view-dm" class="view-panel" style="flex-direction:row;">
                    <div style="width:200px; border-right:1px solid var(--border);">
                        <div style="padding:10px; color:var(--secondary); font-family:'Orbitron';">LINKS</div>
                        <div id="dm-list"></div>
                    </div>
                    <div style="flex:1; display:flex; flex-direction:column;">
                        <div id="dm-header" style="padding:10px; border-bottom:1px solid var(--border); display:none; color:var(--secondary);">...</div>
                        <div id="dm-history" style="flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:10px;"></div>
                        <div id="dm-input-box" class="input-area" style="display:none;">
                            <input id="dm-in" placeholder="Encrypted...">
                            <button class="send-btn" style="background:var(--secondary);" onclick="sendDM()">SEND</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"><\/script>
    <script>
        const URL = '${serverURL}'; 
        // Note: Logic continues inside the new window
        const socket = io(URL);
        let me=null, curChan='general', selUser=null, activeDMs={}, curDM=null;

        socket.on('connect', () => { document.getElementById('conn-status').innerText = "Connected"; document.getElementById('conn-status').style.color = "#00ff00"; });
        socket.on('disconnect', () => { document.getElementById('conn-status').innerText = "Disconnected"; document.getElementById('conn-status').style.color = "#ff0000"; });

        window.attemptLogin = function() {
            const n = document.getElementById('u').value;
            const p = document.getElementById('p').value;
            if(n) socket.emit('join', {name:n, password:p});
        }
        socket.on('loginError', m => document.getElementById('login-err').innerText = m);
        socket.on('loginSuccess', d => {
            me = d.user;
            document.getElementById('login-modal').style.display='none';
            document.getElementById('app').style.display='flex';
            document.getElementById('my-name').innerText = me.name;
            document.getElementById('my-role').innerText = me.role;
        });

        socket.on('loadHistory', msgs => msgs.forEach(m => renderMsg(m, 'chat-history')));
        socket.on('message', m => { if(m.channel && m.channel !== curChan) return; renderMsg(m, 'chat-history'); });
        
        function renderMsg(m, div) {
            const d = document.createElement('div');
            const isMe = me && m.user === me.name;
            // ESCAPED BACKTICKS HERE:
            d.className = \`msg-row \${isMe ? 'mine' : 'theirs'}\`;
            let c = '#00eaff';
            if(m.role === 'Owner') c='#ff3333'; else if(m.role === 'Admin') c='#ffa500';
            d.innerHTML = \`<div class="msg-info" style="color:\${c}">\${m.user}</div><div class="msg-bubble" style="border-left:3px solid \${c}">\${m.text}</div>\`;
            const container = document.getElementById(div);
            container.appendChild(d);
            container.scrollTop = container.scrollHeight;
        }

        window.send = function() {
            const t = document.getElementById('msg-in').value;
            if(t) { socket.emit('chatMessage', {text:t, channel:curChan}); document.getElementById('msg-in').value=''; }
        }
        document.getElementById('msg-in').addEventListener('keyup', e => { if(e.key === 'Enter') send(); });

        socket.on('userList', l => {
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            l.forEach(u => {
                if(me && u.name === me.name) return;
                const d = document.createElement('div');
                d.style.padding = '10px'; d.style.cursor = 'pointer';
                d.style.borderBottom = '1px solid #333';
                let c = '#00ff00'; if(u.role === 'Owner') c='red';
                d.innerHTML = \`<span style="color:\${c}">‚óè</span> \${u.name}\`;
                d.onclick = () => alert('User Menu Placeholder'); 
                list.appendChild(d);
            });
        });
        
        window.setView = function(v) { document.querySelectorAll('.view-panel').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+v).classList.add('active'); }
        window.setChan = function(c) { curChan = c; document.getElementById('chat-history').innerHTML=''; socket.emit('switchChannel', c); setView('chat'); }
    <\/script>
</body>
</html>
            `;

            // 2. Open the window
            const win = window.open('', '_blank');
            
            // 3. Check if Pop-ups were blocked
            if(!win) { 
                alert("POPUP BLOCKED! Check the address bar to allow popups.");
                return; // Stop here if blocked
            }

            // 4. Write content
            win.document.open();
            win.document.write(appCode);
            win.document.close();

            // 5. Redirect THIS window
            setTimeout(() => {
                window.location.replace("https://myapps.classlink.com/home");
            }, 100);
        }
    </script>
</body>
</html>
